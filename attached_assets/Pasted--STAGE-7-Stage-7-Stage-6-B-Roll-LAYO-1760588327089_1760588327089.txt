üéØ –ü–û–ù–Ø–õ! –î–ï–õ–ê–ï–ú STAGE 7!
üìã –ó–ê–î–ê–ß–ê:
Stage 7 = Stage 6 + –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π B-Roll

üé® LAYOUT:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Stage 7: Final Export & B-Roll Generation                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ LEFT (65%)                  ‚îÇ RIGHT (35%)                     ‚îÇ
‚îÇ (–≤—Å—ë –∏–∑ Stage 6)            ‚îÇ (B-Roll –≥–µ–Ω–µ—Ä–∞—Ü–∏—è)              ‚îÇ
‚îÇ                             ‚îÇ                                 ‚îÇ
‚îÇ üìä Timeline                 ‚îÇ üé® Scene B-Roll                 ‚îÇ
‚îÇ ‚îú‚îÄ üé£ Hook (0:00-0:03)      ‚îÇ                                 ‚îÇ
‚îÇ ‚îÇ  [‚ñ∂Ô∏è Preview B-Roll]      ‚îÇ Selected: Hook (0:00-0:03)      ‚îÇ
‚îÇ ‚îú‚îÄ üí™ Main (0:03-0:18)      ‚îÇ                                 ‚îÇ
‚îÇ ‚îÇ  [Generate B-Roll]        ‚îÇ üìù Shot Instructions:           ‚îÇ
‚îÇ ‚îî‚îÄ üéØ CTA (0:18-0:27)       ‚îÇ [textarea]                      ‚îÇ
‚îÇ    [Generate B-Roll]        ‚îÇ "Close-up, dynamic camera..."   ‚îÇ
‚îÇ                             ‚îÇ                                 ‚îÇ
‚îÇ üìù Full Script              ‚îÇ [‚ú® Generate AI Prompt]         ‚îÇ
‚îÇ BREAKING: Coinbase...       ‚îÇ                                 ‚îÇ
‚îÇ                             ‚îÇ AI Prompt (readonly):           ‚îÇ
‚îÇ üé§ Audio Player             ‚îÇ "Stock exchange floor with      ‚îÇ
‚îÇ [‚ñ∂Ô∏è Play] 27.7s             ‚îÇ  traders, dynamic movement..."  ‚îÇ
‚îÇ                             ‚îÇ                                 ‚îÇ
‚îÇ üé¨ Avatar Video             ‚îÇ [üé¨ Generate B-Roll]            ‚îÇ
‚îÇ [Video Player]              ‚îÇ                                 ‚îÇ
‚îÇ                             ‚îÇ Status: ‚è≥ Generating (45%)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Actions:                                                         ‚îÇ
‚îÇ [‚ú® Generate All B-Roll] [üì∏ Screenshot] [‚úÖ Complete] [üì• All] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚ö° –°–ö–ê–ñ–ò AGENT:
```
Implement Stage 7: B-Roll Generation!

LAYOUT:
Left side (65%): Keep ALL Stage 6 content
- Timeline with scenes (no drag-drop needed)
- Each scene shows: [‚ñ∂Ô∏è Preview B-Roll] or [Generate B-Roll]
- Full script
- Audio player
- Avatar video player

Right sidebar (35%): B-Roll generation panel
- Scene selector (which scene to work on)
- Shot instructions textarea
- [Generate AI Prompt] button (Claude API)
- AI-generated prompt (readonly)
- [Generate B-Roll] button (Kie.ai)
- Generation status with progress
- B-Roll preview when ready

Bottom actions:
- [‚ú® Generate All B-Roll] - batch generation
- [üì∏ Save Screenshot] - timeline + script
- [‚úÖ Complete Project]
- [üì• Download All]

TECHNICAL:
1. Use existing Kie.ai service (attached docs)
   - generateVideo() with veo3_fast model
   - aspectRatio: '9:16' (vertical)
   - Polling with exponential backoff
   - Circuit breaker protection

2. Store B-Roll data in project_steps table:
   step_number: 7
   data: {
     scenes: [{
       sceneId: string,
       shotInstructions: string,
       aiPrompt: string,
       taskId: string,
       status: 'idle' | 'generating' | 'completed' | 'failed',
       videoUrl?: string,
       progress?: number
     }]
   }

3. API endpoints needed:
   POST /api/projects/:id/broll/generate
   GET /api/projects/:id/broll/status/:taskId
   POST /api/projects/:id/broll/generate-all

4. Frontend features:
   - Select scene from dropdown
   - Edit shot instructions
   - Generate prompt with Claude
   - Generate B-Roll with Kie.ai
   - Polling for status
   - Preview completed B-Roll
   - Click B-Roll preview ‚Üí fullscreen modal

5. Integration points:
   - Use Stage 3 scenes (editedScenes)
   - Use Stage 4 audio duration for timeline
   - Use Stage 5 video for main content
   - Generate B-Roll for each scene separately
   - Store per-scene B-Roll URLs

NO DRAG & DROP needed!
Just scene selector dropdown + generate buttons.

Start implementation now!
Create stage-7-broll.tsx component first.

üìù –í–ê–ñ–ù–´–ï –î–ï–¢–ê–õ–ò:
1. Kie.ai Integration:
typescriptimport { generateVideo, getVideoStatus } from '@/server/kie-service';

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è B-Roll –¥–ª—è —Å—Ü–µ–Ω—ã:
const result = await generateVideo({
  prompt: aiGeneratedPrompt,
  model: 'veo3_fast',
  aspectRatio: '9:16',
  requestId: `${projectId}-scene-${sceneId}`, // Idempotency
}, storage, userId, 'user');

// Polling —Å—Ç–∞—Ç—É—Å–∞:
const pollStatus = async (taskId: string) => {
  const status = await getVideoStatus(taskId, storage, userId);
  
  if (status.data.status === 'completed') {
    return status.data.videoUrl;
  }
  
  if (status.data.status === 'failed') {
    throw new Error(status.data.error);
  }
  
  // Continue polling...
};
2. Data Structure:
typescript// project_steps (step_number = 7)
{
  scenes: [
    {
      sceneId: 'hook',
      sceneTitle: 'Hook',
      timeRange: '0:00-0:03',
      shotInstructions: 'Close-up, dynamic...',
      aiPrompt: 'Stock exchange floor...',
      taskId: '571395941b6172c5...',
      status: 'completed',
      videoUrl: 'https://...',
      progress: 100,
      keyOwner: 'user',
      keyLast4: 'eb05'
    },
    // ... other scenes
  ]
}
3. UI States:
typescript// Idle (–Ω–µ –Ω–∞—á–∞—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è):
[Generate B-Roll]

// Generating (–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ):
‚è≥ Generating... 45%
[Cancel]

// Completed (–≥–æ—Ç–æ–≤–æ):
‚úÖ Ready
[‚ñ∂Ô∏è Preview] [üîÑ Regenerate]

// Failed (–æ—à–∏–±–∫–∞):
‚ùå Failed: {error}
[üîÑ Retry]