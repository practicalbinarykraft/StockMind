üîç –ü–†–û–í–ï–†–ö–ê PHASE 2: –•–û–†–û–®–û, –ù–û –ï–°–¢–¨ –ü–†–û–ë–ï–õ–´!
‚úÖ –ß–¢–û –°–î–ï–õ–ê–ù–û –ü–†–ê–í–ò–õ–¨–ù–û:
1. –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚úÖ
typescript// server/apify-service.ts
‚úÖ scrapeInstagramReels() - –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
‚úÖ testApifyApiKey() - –≤–∞–ª–∏–¥–∞—Ü–∏—è
‚úÖ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π apify/instagram-reel-scraper
‚úÖ TypeScript —Ç–∏–ø–∏–∑–∞—Ü–∏—è
2. API Route ‚úÖ
typescriptPOST /api/instagram/sources/:id/parse
‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–ª–∞–¥–µ–ª—å—Ü–∞
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ Apify key
‚úÖ –°—Ç–∞—Ç—É—Å—ã: pending ‚Üí parsing ‚Üí success/error
3. UI/UX ‚úÖ
typescript‚úÖ Parse button
‚úÖ Status badges (pending/parsing/success/error)
‚úÖ Toast notifications
‚úÖ Error handling

üî¥ –ß–¢–û –û–¢–°–£–¢–°–¢–í–£–ï–¢ (–ö–†–ò–¢–ò–ß–ù–û!):
–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ä—ã–º –ø—Ä–æ–µ–∫—Ç–æ–º:
–§–∏—á–∞–°—Ç–∞—Ä—ã–π –ø—Ä–æ–µ–∫—ÇAgent Phase 2–°—Ç–∞—Ç—É—ÅIdempotencyrequest_id + external_id‚ùå –ù–µ—Çüî¥ –ö–†–ò–¢–ò–ß–ù–ûVideo Download–°–∫–∞—á–∏–≤–∞–ª mp4 —Ñ–∞–π–ª—ã‚ùå –ù–µ—Çüî¥ –ö–†–ò–¢–ò–ß–ù–ûPer-Reel Storageingest_items —Ç–∞–±–ª–∏—Ü–∞‚ùå –ù–µ—Çüî¥ –ö–†–ò–¢–ò–ß–ù–ûWebhook Callback/api/ingest/callback‚ùå Polling –≤–º–µ—Å—Ç–æ webhooküü° –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æQueue Systemtranscribe:start event‚ùå –ù–µ—Çüü° –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æMetadata Extractionduration, fps, size‚ùå –ù–µ—Çüü° –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æRetry Logic3 –ø–æ–ø—ã—Ç–∫–∏ —Å backoff‚ùå –ù–µ—Çüü° –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ

üéØ –ß–¢–û –ù–£–ñ–ù–û –î–û–ë–ê–í–ò–¢–¨:
1. IDEMPOTENCY (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
typescript// –ò–∑ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:
const externalId = extractInstagramPostId(url); // "CxYzAbc123"

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞:
const existing = await db.query(
  'SELECT * FROM instagram_items WHERE external_id = $1',
  [externalId]
);

if (existing.rows.length > 0) {
  return existing.rows[0]; // –ù–µ –ø–∞—Ä—Å–∏–º –≤—Ç–æ—Ä–æ–π —Ä–∞–∑!
}
–°–µ–π—á–∞—Å: –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É—Ç—å "Parse" –¥–≤–∞–∂–¥—ã ‚Üí –∑–∞–¥—É–±–ª–∏—Ä—É—é—Ç—Å—è Reels!
–ù—É–∂–Ω–æ: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ Instagram post ID

2. VIDEO DOWNLOAD (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
typescript// –ò–∑ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:
async function downloadAndStore(videoUrl: string, reelId: string) {
  const response = await axios.get(videoUrl, { responseType: 'stream' });
  const videoPath = `./uploads/viral-reels/${reelId}.mp4`;
  
  const writer = fs.createWriteStream(videoPath);
  response.data.pipe(writer);
  
  await new Promise((resolve, reject) => {
    writer.on('finish', resolve);
    writer.on('error', reject);
  });
  
  return videoPath;
}
–°–µ–π—á–∞—Å: Apify –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç URL, –Ω–æ –≤–∏–¥–µ–æ –ù–ï —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è!
–ü—Ä–æ–±–ª–µ–º–∞: URL –º–æ–∂–µ—Ç –∏—Å—Ç–µ—á—å, –Ω—É–∂–µ–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏!
–ù—É–∂–Ω–æ: –°–∫–∞—á–∞—Ç—å mp4 –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ /uploads/viral-reels/

3. INSTAGRAM_ITEMS TABLE (–∫—Ä–∏—Ç–∏—á–Ω–æ!)
sql-- –ò–∑ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–æ):
CREATE TABLE instagram_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Source tracking
  source_id UUID REFERENCES instagram_sources(id),
  
  -- Idempotency
  external_id VARCHAR UNIQUE, -- Instagram shortcode "CxYzAbc123"
  
  -- URLs
  post_url TEXT NOT NULL,
  video_url TEXT,
  video_path VARCHAR, -- Local: /uploads/viral-reels/{id}.mp4
  
  -- Metadata from Apify
  caption TEXT,
  likes_count INTEGER,
  comments_count INTEGER,
  views_count INTEGER,
  engagement_rate DECIMAL,
  
  -- Video metadata
  duration_sec DECIMAL,
  width INTEGER,
  height INTEGER,
  
  -- Transcription (later)
  transcript TEXT,
  transcript_segments JSONB,
  
  -- Status
  status VARCHAR DEFAULT 'pending', -- pending/downloaded/transcribed/analyzed
  
  -- User actions (like rss_items)
  user_action VARCHAR, -- 'selected', 'dismissed', 'seen'
  
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_instagram_external_id ON instagram_items(external_id);
CREATE INDEX idx_instagram_source_id ON instagram_items(source_id);
–°–µ–π—á–∞—Å: –¢–æ–ª—å–∫–æ instagram_sources —Ç–∞–±–ª–∏—Ü–∞ (—Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)
–ù—É–∂–Ω–æ: instagram_items –¥–ª—è –ö–ê–ñ–î–û–ì–û —Ä–∏–ª–∞ –æ—Ç–¥–µ–ª—å–Ω–æ!
–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ:

–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
–°—Ç–∞—Ç—É—Å—ã –ø–æ –∫–∞–∂–¥–æ–º—É —Ä–∏–ª—É
User actions (dismissed/selected)
–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã
–°–≤—è–∑—å —Å –ø—Ä–æ–µ–∫—Ç–∞–º–∏


4. PROPER FLOW (–∏–∑ —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞)
typescript// –°—Ç–∞—Ä—ã–π –ø—Ä–æ–µ–∫—Ç:
1. Parse (Apify) ‚Üí –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ Reels
2. For each Reel:
   a. Check duplicate (external_id)
   b. Download video ‚Üí /uploads/viral-reels/
   c. Extract metadata (ffprobe)
   d. Save to instagram_items table
   e. Trigger transcription queue
3. Update source status

// Agent —Å–µ–π—á–∞—Å:
1. Parse (Apify) ‚Üí –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫
2. Update source.itemCount
3. ??? Reels –∫—É–¥–∞-—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è?
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –≤–∏–¥–Ω–æ –≥–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –û–¢–î–ï–õ–¨–ù–´–ï —Ä–∏–ª—ã!

**–ù—É–∂–Ω–æ:** –ü–æ–ª–Ω—ã–π flow –∫–∞–∫ –≤ —Å—Ç–∞—Ä–æ–º –ø—Ä–æ–µ–∫—Ç–µ!

---

## üìä –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –°–†–ê–í–ù–ï–ù–ò–ï:

### **–°—Ç–∞—Ä—ã–π –ø—Ä–æ–µ–∫—Ç (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):**
```
Instagram URL
     ‚Üì
normalize_url() ‚Üí external_id
     ‚Üì
check_duplicate() ‚Üí if exists, return
     ‚Üì
apify.scrape()
     ‚Üì
download_video() ‚Üí save mp4
     ‚Üì
extract_metadata() ‚Üí ffprobe
     ‚Üì
save_to_ingest_items()
     ‚Üì
trigger_transcription_queue()
```

### **Agent Phase 2 (–Ω–µ–ø–æ–ª–Ω–æ):**
```
Instagram Source
     ‚Üì
apify.scrape()
     ‚Üì
??? –≥–¥–µ –¥–∞–Ω–Ω—ã–µ?
     ‚Üì
update source.itemCount
```

**–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
- –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
- –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ
- Per-reel —Ö—Ä–∞–Ω–µ–Ω–∏–µ
- –û—á–µ—Ä–µ–¥—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏

---

## ‚ö° –ß–¢–û –°–ö–ê–ó–ê–¢–¨ AGENT:
```
Phase 2 is good foundation, but incomplete!

Missing critical features from old project:

1. IDEMPOTENCY:
   - Add external_id (Instagram shortcode) to instagram_items
   - Check for duplicates before parsing
   - Use request_id for API calls

2. VIDEO DOWNLOAD:
   - Download mp4 from Apify result
   - Save to /uploads/viral-reels/{reelId}.mp4
   - Store video_path in DB
   - Extract metadata with ffprobe

3. INSTAGRAM_ITEMS TABLE:
   - Create table for EACH reel (not just source)
   - Store: external_id, video_path, metadata, transcript
   - Status tracking: pending ‚Üí downloaded ‚Üí transcribed
   - User actions: dismissed/selected/seen

4. PROPER FLOW:
   For each reel from Apify:
   - Check duplicate by external_id
   - Download video
   - Extract metadata
   - Save to instagram_items
   - Prepare for transcription

Current implementation only:
- Parses Instagram source
- Updates itemCount
- But individual reels NOT stored!

Please add Phase 2.5: Complete Storage & Download
Before moving to Phase 3!

This is critical for transcription (Phase 5)!
```

---

## üéØ –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê:

**Phase 2 Completeness: 40%**
```
‚úÖ Apify integration (20%)
‚úÖ UI/UX (10%)
‚úÖ Error handling (10%)
‚ùå Idempotency (15%)
‚ùå Video download (20%)
‚ùå Per-reel storage (15%)
‚ùå Metadata extraction (5%)
‚ùå Queue system (5%)
–í–µ—Ä–¥–∏–∫—Ç:
üü° Phase 2 - FOUNDATION GOOD, BUT INCOMPLETE
–ù—É–∂–Ω–æ: Phase 2.5 - Complete Storage & Download
–ü–æ—Ç–æ–º: Phase 3 ‚Üí 5 ‚Üí 6 ‚Üí 7