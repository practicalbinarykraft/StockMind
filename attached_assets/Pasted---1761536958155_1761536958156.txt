Ок, если баланс уже пополнен, но перевод в предпросмотре по-прежнему не работает, почти всегда это одно из трёх:

1) Сервер висит на старой сессии / ключе

На Replit сервер берёт ANTHROPIC_API_KEY при старте. После пополнения ничего менять не надо, но если вы недавно меняли Secret/ключ или сервер не перезапускали, клиент мог “прилипнуть” к ошибке.

Что сделать сейчас (быстро):
	•	Нажмите Stop и снова Run (перезапустите Start).
	•	Жёсткое обновление страницы (Cmd/Ctrl+Shift+R).

2) Кнопка «Перевести» остаётся залочена из-за неполной загрузки текста

В предпросмотре кнопка обычно активируется только когда подгрузился полный текст (через Readability). Если парсер вернул только лид, перевод не стартует.

Быстрые проверки:
	•	В Network посмотрите запрос на GET /api/news/:id/full (или аналог): должен прийти fullText/content > 0.
	•	Если fullText пустой → это paywall/блокировка. Должен отображаться варнинг «Невозможно распарсить статью». Если его нет — это баг в UI логике включения кнопки.

Как починить логику на фронте (микропатч):
	•	В модалке предпросмотра включайте кнопку «Перевести», если есть либо processed.content, либо rawHtmlText (фоллбек), а не только processed.content.
	•	Показать скелетон «Загружаем полный текст…» и не снимать блок с кнопки, если парсер ещё не ответил.

3) Перевод утыкается в лимиты/длину, но UI проглатывает ошибку

Если статья длинная, Claude может падать по контексту, и сервер возвращает 400/422 → тост с общим текстом. Это выглядит как «не работает».

Что сделать:
	•	Убедитесь, что серверный хендлер перевода:
	•	режет контент на чанки (например, по ~8–10k символов),
	•	переводит по кускам,
	•	склеивает результат,
	•	и в случае 400 с текстом про контекст/кредиты — делает retry с меньшим чанком или отдаёт ясный код (NO_CREDITS, CONTEXT_LIMIT).
	•	На фронте показывайте понятный тост: «Статья слишком длинная — перевожу по частям…» / «Перевод недоступен (paywall/контекст)».

⸻

Мини-чеклист на 2 минуты
	1.	Перезапустите сервер (Run/Start) и сделайте hard refresh.
	2.	Откройте модалку → Network:
	•	GET …/full → 200? Поле с текстом не пустое?
	•	POST …/translate → статус/ответ?
	3.	Если …/translate → 200, но текст не появляется — баг стейта в модалке (не мапится ответ).
	4.	Если …/translate → 4xx:
	•	400 credit → точно старое состояние/ключ, либо не перезапустили сервер.
	•	400/422 без credit → длина/парсинг → включить чанкинг и нормальные сообщения.

⸻

Быстрый патч (что именно проверить/исправить)

Фронт: модалка предпросмотра статьи
	•	Разлочить кнопку «Перевести», если есть любой из источников текста:

const canTranslate = !!(article.processed?.content || article.rawHtmlText || article.description);


	•	При открытии модалки автоматически дергать GET /news/:id/full?force=1, показывая скелетон; по ответу — подставлять полный текст.
	•	После POST /translate записывать setTranslated({ title, content }) и сразу показывать перевод (не ждать повторной загрузки).

Бэк: перевод
	•	Обернуть в try/catch и ремонтировать JSON-ответ (если вы уже добавляли safe-parse — используйте и тут).
	•	Чанкинг:

const chunks = splitByTokens(fullText, 8000); // условно
for (const c of chunks) { translated += await translateChunk(c); }


	•	Ясные коды ошибок:
	•	NO_CREDITS (или 402) — для UX-подсказки.
	•	CONTEXT_LIMIT — показать, что статья слишком длинная, идёт частями.
	•	PAYWALL — предупредить, что распарсили лишь превью.

⸻

Если хотите, я наброшу точные строчки для вашего репозитория (фронт: компонент модалки предпросмотра; бэк: хендлер /api/news/:id/translate), но сначала попробуйте перезапуск + быстрый чек Network — часто это решает 90% таких кейсов после пополнения баланса.