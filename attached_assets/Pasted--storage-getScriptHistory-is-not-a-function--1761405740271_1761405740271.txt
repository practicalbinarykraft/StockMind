

üß© –¢–ó: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É storage.getScriptHistory is not a function –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ ‚Äú–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∞–Ω–∞–ª–∏–∑‚Äù

üü• –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –≤—ã–∑–æ–≤–µ API /api/projects/:id/reanalyze –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π:

500: {"success":false,"error":"storage.getScriptHistory is not a function"}

–§—Ä–æ–Ω—Ç–µ–Ω–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚Äî –æ—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ backend.
–ó–Ω–∞—á–∏—Ç, –≤ server/routes.ts –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ storage.getScriptHistory.

‚∏ª

üß† –ü—Ä–∏—á–∏–Ω–∞

–í –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö backend API –º–æ–¥—É–ª—å storage.ts –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ—Ç–æ–¥–∞ getScriptHistory.
–ï–≥–æ –ª–∏–±–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª–∏, –ª–∏–±–æ –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏–π —Å—Ü–µ–Ω–∞—Ä–∏—è.

–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –≤ –∫–æ–¥–µ /api/projects/:id/reanalyze –µ—Å—Ç—å —Å—Ç—Ä–æ–∫–∞:

const history = await storage.getScriptHistory(projectId)

–ù–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî storage.listScriptVersions(projectId),
–∏–ª–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è ‚Äî storage.getCurrentScriptVersion(projectId).

‚∏ª

‚úÖ –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

1. –í server/routes.ts

–ù–∞–π—Ç–∏ –±–ª–æ–∫:

app.post('/api/projects/:id/reanalyze', async (req, res) => {
  const projectId = req.params.id
  const history = await storage.getScriptHistory(projectId)
  ...
})

–ò –∑–∞–º–µ–Ω–∏—Ç—å –µ–≥–æ –Ω–∞:

app.post('/api/projects/:id/reanalyze', async (req, res) => {
  const projectId = req.params.id

  // ‚úÖ –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é —Å—Ü–µ–Ω–∞—Ä–∏—è
  const currentVersion = await storage.getCurrentScriptVersion(projectId)
  if (!currentVersion) {
    return res.status(404).json({ success: false, error: "No current script version found" })
  }

  // ‚öôÔ∏è –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ—Å—á—ë—Ç –∞–Ω–∞–ª–∏–∑–∞
  const result = await aiService.reanalyzeScript(currentVersion)

  // üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–Ω—É—é –≤–µ—Ä—Å–∏—é
  const candidate = await storage.createScriptVersion({
    projectId,
    baseVersionId: currentVersion.id,
    isCandidate: true,
    scenes: result.scenes,
    metrics: result.metrics,
    review: result.review,
  })

  return res.json({ success: true, data: { candidateVersionId: candidate.id } })
})


‚∏ª

2. –í server/storage.ts

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —ç—Ç–∏ –º–µ—Ç–æ–¥—ã:

export async function getCurrentScriptVersion(projectId: string) {
  const result = await sql`
    SELECT * FROM script_versions
    WHERE project_id = ${projectId} AND is_current = true
    LIMIT 1
  `
  return result[0] || null
}

export async function createScriptVersion(data: {
  projectId: string
  baseVersionId?: string
  isCandidate?: boolean
  scenes: any[]
  metrics?: any
  review?: string
}) {
  const result = await sql`
    INSERT INTO script_versions (project_id, base_version_id, is_candidate, scenes, metrics, review)
    VALUES (${data.projectId}, ${data.baseVersionId || null}, ${data.isCandidate || false}, ${JSON.stringify(data.scenes)}, ${JSON.stringify(data.metrics || null)}, ${data.review || null})
    RETURNING *
  `
  return result[0]
}


‚∏ª

3. –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
	1.	–û—Ç–∫—Ä—ã—Ç—å –ª—é–±–æ–π –ø—Ä–æ–µ–∫—Ç.
	2.	–ü–µ—Ä–µ–π—Ç–∏ –≤ Stage 3 ‚Üí –Ω–∞–∂–∞—Ç—å ¬´–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∞–Ω–∞–ª–∏–∑¬ª.
	3.	‚úÖ –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –º–æ–¥–∞–ª–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –î–æ / –ü–æ—Å–ª–µ.
	4.	–í –∫–æ–Ω—Å–æ–ª–∏ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫ 500.
	5.	–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ script_versions —Å is_candidate = true.

‚∏ª

4. Acceptance Criteria
	‚Ä¢	–û—à–∏–±–∫–∞ storage.getScriptHistory is not a function –±–æ–ª—å—à–µ –Ω–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç.
	‚Ä¢	API /api/projects/:id/reanalyze –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 { success: true, data: { candidateVersionId } }.
	‚Ä¢	–ü–µ—Ä–µ—Å—á—ë—Ç –∞–Ω–∞–ª–∏–∑–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é —Å—Ü–µ–Ω–∞—Ä–∏—è.
	‚Ä¢	–ú–æ–¥–∞–ª–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ –ø–∞–¥–µ–Ω–∏–π.

‚∏ª
