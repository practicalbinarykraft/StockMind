отлично, фокусируемся только на Инсте: подключение аккаунта и стабильный парсинг результатов с привязкой к версиям сценария. Ниже готовое ТЗ для реплита — коротко, чётко и с проверяемыми критериями.

Цель

Дать пользователю возможность:
	1.	подключить свой Instagram Professional (через Meta/Facebook Graph),
	2.	выбрать опубликованный Reels,
	3.	автоматически подтягивать и обновлять его метрики,
	4.	связать этот пост с конкретной версией сценария в проекте,
	5.	видеть “Ожидали vs По факту” и советы от AI-архитектора.

⸻

Архитектура (в общих чертах)
	•	OAuth через Facebook Login → пользовательский токен → Long-Lived User Token → список страниц → выбор страницы → IG User ID.
	•	Sync-сервис: регулярный сбор постов и метрик (пуллинг), бэкофф при 429/5xx, авто-обновление токенов, расписание повторных синков.
	•	Хранилище: нормализованные таблицы Projects/Versions/IgAccounts/IgMedia/Insights + “сырые” данные на случай расширения метрик.
	•	Мэппинг: привязка Reels ↔ Version (через вставку ссылки в Stage 7/8 или через хеш-теги/UTM-подпись).
	•	Дашборд в проекте: сравнение предсказаний с фактами и рекомендации.

⸻

Пермишены/предпосылки
	•	Требуем тип аккаунта: Instagram Business/Creator, привязанный к Facebook Page.
	•	Запрашиваемые разрешения (через Facebook App):
instagram_basic, pages_show_list, pages_read_engagement, instagram_manage_insights (если названия отличаются — брать актуальные в консоли Meta; код должен быть готов к частичным наборам прав и корректно подсвечивать недостающие).
	•	Вебхуки не обязательны (инсайты удобнее пуллить), но можно подписаться на instagram/page для нотификаций о новых постах — это опционально (за рамками первой итерации).

⸻

Модель данных (миграции)

// Новый блок в shared schema (псевдотипы)
IgAccount {
  id: string;                 // our UUID
  userId: string;             // владелец в нашей системе
  fbUserId: string;           // Facebook user id
  fbPageId: string;           // выбранная страница
  igUserId: string;           // connected Instagram account id
  accessTokenLL: string;      // long-lived user token (зашифрованно)
  tokenExpiresAt: Date;       // истечение LL токена
  createdAt: Date; updatedAt: Date;
}

IgMedia {
  id: string;                 // our UUID
  igAccountId: string;
  igMediaId: string;          // Graph id
  permalink: string;
  mediaType: 'REEL'|'VIDEO'|'IMAGE'|'CAROUSEL'|'UNKNOWN';
  caption: string | null;
  thumbnailUrl: string | null;
  publishedAt: Date;
  lastSyncedAt: Date | null;
  nextSyncAt: Date | null;    // план следующего опроса
  syncStatus: 'idle'|'queued'|'syncing'|'ok'|'error'|'rate_limited';
  syncError: string | null;   // последняя причина
  createdAt: Date; updatedAt: Date;
}

IgMediaInsight {
  id: string;                         // our UUID
  igMediaId: string;                  // FK -> IgMedia.igMediaId (Graph id) или на наш IgMedia.id — на выбор, но единообразно
  collectedAt: Date;                  // когда взяли срез
  // общий гибкий словарь метрик:
  metrics: Record<string, number>;    // "plays","reach","impressions","likes","comments","saves","shares", ...
  raw: any;                           // сырой ответ Graph (JSON) для будущих расширений
}

ProjectVersionBinding {
  id: string;
  projectId: string;
  versionId: string;        // vN
  igMediaId: string;        // наш IgMedia.id
  bindType: 'manual'|'tagged'|'auto';
  createdAt: Date;
}

Важный момент: не жёстко перечисляйте метрики в схеме — кладите и нормализованную “витрину” (из часто используемых), и metrics как словарь + raw. Это переживёт любые изменения Graph API.

⸻

API (сервер)

OAuth/аккаунт
	•	GET /api/ig/auth/url → { url }
Возвращает URL Facebook-логина с нужными scope.
	•	GET /api/ig/auth/callback?code=... → создаёт/обновляет IgAccount, делает exchange на long-lived токен.
Ответ: { success, igUserId, fbPageId } или явные ошибки (нет привязки страницы/инсты и т.п.).
	•	GET /api/ig/accounts → список подключённых аккаунтов текущего пользователя.
	•	DELETE /api/ig/accounts/:id → отвязать (удалить токены, прекратить синки).

Медиа и привязка
	•	GET /api/ig/:accountId/media?type=reels&since=...&until=...
Возвращает список последних постов с базовой информацией (id, caption, permalink, timestamps, mediaType, статус синка).
	•	POST /api/ig/bind
Body: { projectId, versionId, igMediaId } → создаёт ProjectVersionBinding.
	•	DELETE /api/ig/bind/:bindingId

Инсайты/синк
	•	POST /api/ig/:accountId/sync/enqueue → планирует фоновый сбор для всего REEL за последние N дней (N=30 по умолчанию).
	•	POST /api/ig/media/:igMediaId/sync → форс-синк одного поста (с бэкоффом).
	•	GET /api/ig/media/:igMediaId/insights
Возвращает последнюю агрегированную витрину + историю срезов.

Project Analytics (для UI проекта)
	•	GET /api/projects/:id/performance
Возвращает:
	•	список версий {versionId, predictedMetrics, boundMedia?}
	•	по boundMedia: permalink, publishedAt, lastSyncedAt, latestActualMetrics, дельты (pred vs actual)
	•	краткий текст совета от AI-архитектора (можно синтезировать сейчас из дельт, не блокируясь на “мультиагента”).

⸻

Сервис синхронизации
	•	Задачи:
	•	Пуллить ленту Reels для подключённых IgAccount.
	•	Для каждого иг-медиа тянуть доступные insights (список метрик формируем динамически — запрашиваем «все доступные», маппим в словарь).
	•	Экспоненциальный backoff на 429/5xx: 1s → 3s → 7s; макс 3 попытки; статус rate_limited/error, nextSyncAt увеличивается.
	•	План обновлений: первые 48 часов — чаще (каждые 30–60 мин), далее до 30 дней — раз в сутки. Поле nextSyncAt хранит расписание, периодический воркер забирает “просроченные”.
	•	Токены:
	•	Хранить LL токен с tokenExpiresAt.
	•	За 14 дней до истечения — показывать нотификацию в UI.
	•	Ошибки “invalid/expired token” → статус аккаунта auth_error, в UI кнопка “Переавторизовать”.

⸻

UI/UX

Stage “Performance” (или вкладка “Analytics” в проекте)
	•	Блок Подключение аккаунта: подключить/отвязать, статус токена.
	•	Блок Выбор поста: таблица Reels (перmalink, дата, превью, статус синка, последние метрики), кнопка “Привязать к версии…”.
	•	Блок Сравнение версий: лист версий v1…vN
	•	для каждой: predicted {retention, saves, shares, …}
	•	если привязан пост: actual + дельты
	•	бейдж “обновлено X минут назад”, кнопка “Обновить сейчас”.
	•	Блок Рекомендации AI-архитектора: 3–5 коротких буллетов на основе дельт (например: “Хук ниже ожиданий → сократить подводку”, “CTA не сработал → протестируйте вопрос вместо призыва к комментарию”).

Stage 7 (“Storyboard”) / Final
	•	Поле “Вставьте ссылку на опубликованный Reels” → парсим permalink → ищем igMediaId → предлагаем “Привязать к версии vN”.

Статусы и тосты
	•	“Аккаунт подключён”, “Не хватает прав: XXX”, “Синк запущен”, “Лимит API — повторяю позже”, “Токен устарел — переавторизуйте”.

⸻

Логика привязки версии

При привязке показываем выпадающий список версий проекта (v1…vN).
Хорошая практика: во время публикации добавлять в подпись служебный тег, например: #stockmind:proj:<projectId>:v:<versionId> — тогда сможем и автоматически предлагать привязку при импорте ленты (опционально; можно на потом).

⸻

Обработка метрик

Метрики в Инсте различаются по типу поста/уровню доступа. Поэтому:
	•	Сервер забирает все доступные ключи и кладёт в IgMediaInsight.metrics (словарь).
	•	Для витрины используем маппинг по приоритету:
	•	Удержание: если есть plays + длина → строим кривую (нет — показываем недоступно).
	•	Охват/просмотры: берём доступные reach/impressions/views.
	•	Вовлечённость: likes, comments, saves, shares.
	•	Если что-то недоступно — не фейлимся, помечаем “недоступно” и выводим подсказку какие права нужны.

⸻

Обработка ошибок/лимитов
	•	429/5xx: ретраи с бэкоффом (1/3/7 сек), syncStatus='rate_limited', nextSyncAt сдвигаем.
	•	400/403: чёткое сообщение (нет прав/аккаунт не business/нет связанной страницы).
	•	Token expired: переводим аккаунт в auth_error, UI — кнопка “Переавторизовать”.
	•	Персистентный фейл: помечаем syncStatus='error', пишем syncError (последний текст), не спамим повторами.

⸻

Acceptance Criteria (проверяемое командой)
	1.	Я могу подключить Instagram, выбрать страницу и подключённый IG аккаунт. Статус аккаунта виден в UI.
	2.	Я вижу список своих Reels с превью, датой и статусом синка.
	3.	С любого Reels могу нажать “Привязать к версии”, выбрать vN и сохранить.
	4.	В проекте на вкладке Analytics я вижу predicted vs actual по привязанной версии.
	5.	Метрики обновляются автоматически без ручного вмешательства согласно расписанию; кнопка “Обновить сейчас” работает.
	6.	При rate-limit/ошибках я получаю понятное уведомление, статус поста/аккаунта отображается.
	7.	При истечении токена система просит переавторизоваться, после этого синки продолжаются.
	8.	Данные хранятся в наших таблицах; сырые ответы доступны в raw для отладки.
	9.	Никаких «жёстких таймаутов» — фоновая очередь и бэкофф уже реализованы и используются.

⸻

Тест-план (smoke)
	•	Подключение аккаунта с корректными правами.
	•	Попытка подключить личный Instagram (ожидаем корректную ошибку).
	•	Импорт ленты, выбор Reels, привязка к версии vN.
	•	Принудительный синк одного поста (успешный и с имитацией 429).
	•	Обновление токена (симулируем устаревший).
	•	Просмотр дашборда: корректные дельты, отсутствие крашей при “частичных” метриках.
	•	Отвязка аккаунта: все фоновые джобы останавливаются.

⸻

Что именно сделать реплиту (чек-лист задач)
	•	Миграции для IgAccount, IgMedia, IgMediaInsight, ProjectVersionBinding.
	•	Модуль OAuth: авторизация, exchange, LL токен, выбор Page → IG User.
	•	Сервис синка (очередь + воркер): импорт ленты, сбор инсайтов, бэкофф, расписание.
	•	REST эндпоинты (см. список выше) + apiResponse.* JSON-ответы.
	•	UI “Performance/Analytics”: подключение, лента, привязка, сравнение, обновление, подсказки.
	•	Встроить в Stage 7/Final поле для ссылки на Reels с быстрым биндингом.
	•	Тосты/статусы/рекавери токена.
	•	Документация в replit.md: как включить, какие пермишены, как тестировать на тестовом бизнес-аккаунте.

если ок — даю короткие “issues” по каждому подпункту с Acceptance Criteria и примерами запросов/ответов.