–æ–±–æ–∂–∞—é —ç—Ç–æ üôå –¥–∞–≤–∞–π –¥–æ–≤–µ–¥—ë–º –∏–¥–µ—é –¥–æ ¬´–∫–∏–ª–ª–µ—Ä-—Ñ–∏—á–∏¬ª –≤ –ø—Ä–æ–¥ ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –º–∞–≥–∏—á–Ω–æ –¥–ª—è —é–∑–µ—Ä–∞ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ –¥–ª—è –Ω–∞—Å.

üö¶ –ß—Ç–æ –¥–µ–ª–∞–µ–º –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å (–∫–æ—Ä–æ—Ç–∫–æ)
	1.	–í–≤–æ–¥–∏–º –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ + –¥–∏—Ñ—Ñ—ã (—É —Ç–µ–±—è —É–∂–µ –ø–æ—á—Ç–∏ –≤—Å—ë –µ—Å—Ç—å ‚Äî –¥–æ—Ç–æ—á–∏–º –ø–æ–ª—è –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã).
	2.	–î–µ–ª–∞–µ–º –∞–≥–µ–Ω—Ç–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É (Hook/Structure/Clarity/Retention/CTA) + ¬´–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä¬ª (meta-review).
	3.	–î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å¬ª/¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å—ë¬ª/¬´–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑¬ª/¬´–ò—Å—Ç–æ—Ä–∏—è¬ª –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ —Å—Ü–µ–Ω (MVP UI).
	4.	–í—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ç–ª—é –æ–±—É—á–µ–Ω–∏—è: —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏—á–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è ‚Üí —Å–≤—è–∑—ã–≤–∞–µ–º —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ ‚Üí ¬´–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä¬ª –æ–±–Ω–æ–≤–ª—è–µ—Ç —ç–≤—Ä–∏—Å—Ç–∏–∫–∏/–ø—Ä–æ–º–ø—Ç—ã.
	5.	–ì–æ—Ç–æ–≤–∏–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Instagram Insights (–ø–æ–∑–∂–µ –≤–∫–ª—é—á–∏–º prod-–∫–ª—é—á–∏; —Å–µ–π—á–∞—Å ‚Äî –∞–¥–∞–ø—Ç–µ—Ä/–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã + –±—ç–∫-–∑–∞–≥–ª—É—à–∫–∞).

‚∏ª

1) –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π, –Ω–æ –º–æ—â–Ω—ã–π –∞–ø–≥—Ä–µ–π–¥)

script_versions ‚Äî –¥–æ–±–∞–≤–∏–º:
	‚Ä¢	provenance jsonb ‚Äî –æ—Ç–∫—É–¥–∞ –≤–µ—Ä—Å–∏—è: { agent:"hook", source:"ai|user|bulk", inputs:{...}, prompt_hash:"..." }
	‚Ä¢	scores jsonb ‚Äî —Ä–∞–∑–ª–æ–∂–µ–Ω–∏–µ: { overall:73, hook:85, retention:68, cta:60, pace:72 }
	‚Ä¢	diff jsonb ‚Äî canonical-diff –ø–æ —Å—Ü–µ–Ω–∞–º: [{sceneId, before, after}] –¥–ª—è –¥–µ—à—ë–≤–æ–π –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ ¬´–ë—ã–ª–æ/–°—Ç–∞–ª–æ¬ª
	‚Ä¢	features jsonb ‚Äî –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —Ñ–∏—á–∏ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è (—Å–º. –ø.4)

scene_recommendations ‚Äî –¥–æ–±–∞–≤–∏–º:
	‚Ä¢	source_agent text ‚Äî –∫–∞–∫–æ–π –∞–≥–µ–Ω—Ç –¥–∞–ª —Å–æ–≤–µ—Ç: hook|structure|clarity|cta
	‚Ä¢	score_delta int ‚Äî –æ–∂–∏–¥–∞–µ–º—ã–π –ø—Ä–∏—Ä–æ—Å—Ç –æ—á–∫–æ–≤
	‚Ä¢	confidence float ‚Äî —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (–¥–ª—è –ø–æ—Ä—è–¥–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å—ë¬ª)

publication_metrics (–Ω–æ–≤–∞—è): —Å–≤—è–∑—ã–≤–∞–µ—Ç –≤–µ—Ä—Å–∏—é —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–π —Ä–∏–ª—Å

id, project_id, script_version_id, platform('instagram'),
post_url, post_id, captured_at, metrics jsonb  -- {views, reach, avg_watch, comp_rate, saves, shares, comments}

learning_samples (–Ω–æ–≤–∞—è): –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä—ã ¬´—Ñ–∏—á–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è ‚Üí —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏¬ª
id, script_version_id, features jsonb, metrics jsonb, label float (–Ω–∞–ø—Ä–∏–º–µ—Ä watch_pct)

—Ç–∞–∫ –º—ã —Å–º–æ–∂–µ–º —É—á–∏—Ç—å –ø—Ä–æ—Å—Ç—ã–µ –º–æ–¥–µ–ª–∏/—ç–≤—Ä–∏—Å—Ç–∏–∫—É –±–µ–∑ —Ç—è–∂—ë–ª–æ–≥–æ ML-—Å—Ç–µ–∫–∞.

‚∏ª

2) –ê–≥–µ–Ω—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ (—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏)
	‚Ä¢	Agent: Hook ‚Äî —Å–∏–ª–∞ —Ö—É–∫–∞, –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞, —Ü–∏—Ñ—Ä—ã, –∫–æ–Ω—Ñ–ª–∏–∫—Ç, –ø–∞—Ç—Ç–µ—Ä–Ω—ã: ¬´—á–∏—Å–ª–æ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ¬ª, ¬´–∫–æ–Ω—Ç—Ä–∞—Å—Ç –æ–∂–∏–¥–∞–Ω–∏–µ/—Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å¬ª.
	‚Ä¢	Agent: Structure/Pacing ‚Äî –¥–ª–∏–Ω—ã —Å—Ü–µ–Ω, –±–∞—Ç—á–∏ —Å–º—ã—Å–ª–∞, —Ä–∞–∑–º–µ—Ç–∫–∞: hook‚Üípayoff‚ÜíCTA, ¬´–∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥ —Å–æ–±—ã—Ç–∏–µ¬ª.
	‚Ä¢	Agent: Clarity/Language ‚Äî –∫—Ä–∞—Ç–∫–æ—Å—Ç—å, –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–ª–æ–≥, —á–∏—Ç–∞–µ–º–æ—Å—Ç—å, —Ä—É—Å—Å–∫–∞—è —Å–µ–º–∞–Ω—Ç–∏–∫–∞.
	‚Ä¢	Agent: Retention ‚Äî –º–æ–º–µ–Ω—Ç—ã –ø—Ä–æ–≤–∞–ª–∞ —É–¥–µ—Ä–∂–∞–Ω–∏—è: ¬´—Å–∫—É—á–Ω—ã–π –≥–ª–∞–≥–æ–ª¬ª, ¬´–Ω–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —è–∫–æ—Ä—è¬ª.
	‚Ä¢	Agent: CTA ‚Äî —Ñ–æ—Ä–º—É–ª–∞ CTA –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É (¬´—Å–æ—Ö—Ä–∞–Ω–∏ ‚áí –∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–≤—Ç—Ä–∞¬ª, ¬´–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π ‚Äò–≥–æ—Ç–æ–≤‚Äô¬ª).

–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä:
	‚Ä¢	–∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Üí –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç (dedupe/merge) ‚Üí —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ priority, score_delta, confidence
	‚Ä¢	–¥–∞—ë—Ç summary + ¬´–ø–ª–∞–Ω –ª–µ—á–µ–Ω–∏—è¬ª (3‚Äì5 –¥–µ–π—Å—Ç–≤–∏–π)
	‚Ä¢	–º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å bulk-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é (–æ–¥–∏–Ω –ø–∞—Ç—á –ø—Ä–∞–≤–∏—Ç 2‚Äì3 —Å—Ü–µ–Ω—ã —Ä–∞–∑–æ–º)

–¢–µ—Ö. –¥–µ—Ç–∞–ª—å: –≤—ã–∑—ã–≤–∞—Ç—å —á–µ—Ä–µ–∑ —Ç–≤–æ–π model-registry (–±–µ–∑ ¬´opus/4-5¬ª –∏ –ø—Ä–æ—á–∏—Ö —Ñ–∞–Ω—Ç–æ–º–æ–≤), —Ç–æ–ª—å–∫–æ –∞–ª–∏–∞—Å—ã.

‚∏ª

3) API (—Ä–æ–≤–Ω–æ –ø–æ–¥ UI, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ)
	‚Ä¢	GET /api/projects/:id/script-history ‚Üí { currentVersion, versions, recommendations, hasUnapplied }
	‚Ä¢	POST /api/projects/:id/reanalyze ‚Üí –∑–∞–ø—É—Å–∫–∞–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤, –ø–∏—à–µ—Ç script_versions + scene_recommendations
	‚Ä¢	POST /api/projects/:id/apply-scene-recommendation {sceneId, recommendationId}
	‚Ä¢	POST /api/projects/:id/apply-all-recommendations (—Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ priority, score_delta)
	‚Ä¢	POST /api/projects/:id/edit-scene {sceneId, newText} ‚Üí —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é —Å provenance.source='user'
	‚Ä¢	POST /api/projects/:id/revert-to-version {versionId}
	‚Ä¢	POST /api/insights/instagram/link {postUrl} ‚Üí —Å–æ–∑–¥–∞—ë—Ç publication_metrics (–ø–æ—Å–ª–µ –∫—Ä—É–¥–∞ —Å–º–æ—Ç—Ä–∏–º –º–µ—Ç—Ä–∏–∫–∏)
	‚Ä¢	POST /api/insights/instagram/pull {postId} ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ (–∫—Ä–æ–Ω–æ–º –∏–ª–∏ –≤—Ä—É—á–Ω—É—é)

–§–æ–Ω–æ–≤—ã–µ –¥–∂–æ–±—ã
	‚Ä¢	jobs/analysis-runner ‚Äî –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ –∞–≥–µ–Ω—Ç–æ–≤ + ¬´–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä¬ª
	‚Ä¢	jobs/insights-poller ‚Äî –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ—Ç –∏–Ω—Å–∞–π—Ç—ã 24/72 —á, 7 –¥–Ω–µ–π (—Å–∞–º—ã–µ –ø–æ–ª–µ–∑–Ω—ã–µ –æ–∫–Ω–∞)
	‚Ä¢	jobs/learning-builder ‚Äî –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –≤–µ—Ä—Å–∏–∏+–º–µ—Ç—Ä–∏–∫–∏ –≤ learning_samples

‚∏ª

4) ¬´–ü–µ—Ç–ª—è –æ–±—É—á–µ–Ω–∏—è¬ª (–±–µ–∑ —Ç—è–∂—ë–ª–æ–π ML —Å–µ–π—á–∞—Å, –Ω–æ —Å –ø–æ–ª—å–∑–æ–π)
	‚Ä¢	Feature extractor (Node): –∏–∑ –≤–µ—Ä—Å–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è –¥–µ–ª–∞–µ–º —Ñ–∏—á–∏:
	‚Ä¢	–¥–ª–∏–Ω—ã —Å—Ü–µ–Ω, –¥–æ–ª—è hook, –ø–ª–æ—Ç–Ω–æ—Å—Ç—å —á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö/¬´—Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã—Ö¬ª —Å–ª–æ–≤, –Ω–∞–ª–∏—á–∏–µ ¬´–≤–∏–∑—É–∞–ª—å–Ω—ã—Ö —è–∫–æ—Ä–µ–π¬ª, CTA-—Ç–∏–ø
	‚Ä¢	—Å–∏–º–ø–ª BERT-—ç–º–±–µ–¥–¥–∏–Ω–≥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ–∑–∂–µ)
	‚Ä¢	Target: avg_watch_pct, comp_rate, saves_per_view, shares_per_view
	‚Ä¢	Learner v0 (—ç–≤—Ä–∏—Å—Ç–∏–∫–∞ + —Ä–µ–≥—Ä–µ—Å—Å–∏—è):
	‚Ä¢	–ø—Ä–æ—Å—Ç–∞—è –ª–∏–Ω–µ–π–∫–∞/LightGBM –∏–∑ features ‚Üí target (–æ—Ñ–ª–∞–π–Ω –≤ –≤–æ—Ä–∫–µ—Ä–µ, –º–æ–¥–µ–ª—å –≤ JSON)
	‚Ä¢	¬´–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä¬ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–µ—Å–∞ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ expected impact –∏ –ø–æ—Ä—è–¥–∫–∞ ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å—ë¬ª
	‚Ä¢	Safety/Guardrails: —á—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–æ–∫—Å–∏—á–Ω—ã—Ö –ø—Ä–∏—ë–º–æ–≤, –±—Ä–µ–Ω–¥-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∞–≥–µ–Ω—Ç —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

‚∏ª

5) UI (–º–∞–≥–∏—è –±–µ–∑ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–≥–æ —à—É–º–∞)
	‚Ä¢	–ì–ª–∞–≤–Ω–∞—è –ø–æ–ª–æ—Å–∞: Score + breakdown (–ø–æ–ª–æ—Å–∫–∏ Hook/Retention/CTA), –∫–Ω–æ–ø–∫–∞ –ò—Å—Ç–æ—Ä–∏—è
	‚Ä¢	–°—Ü–µ–Ω—ã:
	‚Ä¢	inline-—Ä–µ–¥–∞–∫—Ç–æ—Ä, –±–µ–π–¥–∂–∏ ¬´Edited/Improved¬ª
	‚Ä¢	–µ—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è ‚Üí –∂—ë–ª—Ç–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å Expected impact –∏ [‚ú® –ü—Ä–∏–º–µ–Ω–∏—Ç—å]
	‚Ä¢	—Å–Ω–∏–∑—É: [‚ú® –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ] (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫) + [üîÑ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ] (–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ä—É—á–Ω—ã—Ö –ø—Ä–∞–≤–æ–∫)
	‚Ä¢	–ò—Å—Ç–æ—Ä–∏—è (modal): —Å–ª–µ–≤–∞ ‚Äî –≤–µ—Ä—Å–∏–∏ (—Ç–∏–ø –∏–∑–º–µ–Ω–µ–Ω–∏—è + –≤—Ä–µ–º—è), —Å–ø—Ä–∞–≤–∞ ‚Äî ¬´–ë—ã–ª–æ/–°—Ç–∞–ª–æ¬ª (–∏–∑ diff), –∫–Ω–æ–ø–∫–∞ Restore
	‚Ä¢	–µ—Å–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–µ—Ç ‚Äî —Å–ø—Ä–∞–≤–∞ CTA-–ø–ª–∞—à–∫–∞ ¬´–Ω–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏¬ª
	‚Ä¢	–ú–∏–∫—Ä–æ-–∞–Ω–∏–º–∞—Ü–∏–∏: –ø—Ä–∏–º–µ–Ω–∏–ª–∏ –ø–∞—Ç—á ‚Üí –∑–µ–ª—ë–Ω–∞—è –≤—Å–ø—ã—à–∫–∞ —Å—Ç—Ä–æ–∫–∏, ¬´+18 –∫ Hook¬ª –Ω–∞ 1.2—Å

‚∏ª

6) –ì–æ—Ç–æ–≤—ã–µ ¬´–∫–∏—Ä–ø–∏—á–∏¬ª –∫–æ–¥–∞ (–≤–∫–ª–µ–∏–≤–∞–π –∫–∞–∫ –µ—Å—Ç—å)

–ö–æ–Ω—Ç—Ä–∞–∫—Ç –∞–≥–µ–Ω—Ç–∞

// server/analysis/agents/types.ts
export type AgentName = 'hook'|'structure'|'clarity'|'retention'|'cta';

export interface SceneRec {
  sceneId: number;
  priority: 'high'|'medium'|'low';
  area: string;                 // e.g. 'hook-number', 'pacing-cut'
  suggestedText: string;
  reasoning: string;
  expectedImpact?: string;      // "+18 points", "+35% saves"
  scoreDelta?: number;          // 0..100
  confidence?: number;          // 0..1
  sourceAgent: AgentName;
}
export interface AgentResult {
  perScene: SceneRec[];
  summary: string;
  scores?: Partial<{ overall:number; hook:number; retention:number; cta:number; pace:number }>;
}
export interface Agent {
  name: AgentName;
  run(input: { scenes: Array<{id:number;text:string;start?:number;end?:number}>, locale?: string }): Promise<AgentResult>;
}

–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä (–∞–≥—Ä–µ–≥–∞—Ü–∏—è)

// server/analysis/architect.ts
import { Agent, AgentResult, SceneRec } from './agents/types';

export async function runAnalysisPipeline(agents: Agent[], script: any) {
  const results = await Promise.all(agents.map(a => a.run({ scenes: script.scenes, locale: 'ru' })));
  const recs = dedupe(sort(flatten(results.map(r => r.perScene))));
  const scores = mergeScores(results);

  return { recommendations: recs, scores, summary: makeSummary(results) };
}

function sort(recs: SceneRec[]) {
  return recs.sort((a,b) => (prio(b)-prio(a)) || (b.scoreDelta||0)-(a.scoreDelta||0) || (b.confidence||0)-(a.confidence||0));
}
const prio = (r: SceneRec) => r.priority==='high'?3:r.priority==='medium'?2:1;
function dedupe(recs: SceneRec[]) {
  const key = (r: SceneRec) => `${r.sceneId}:${r.area}:${hash(r.suggestedText)}`;
  const seen = new Set<string>();
  return recs.filter(r => (seen.has(key(r)) ? false : (seen.add(key(r)), true)));
}
function mergeScores(list: AgentResult[]) {
  const out: any = {}; for (const r of list) for (const [k,v] of Object.entries(r.scores||{})) out[k]=(out[k]||0)+v;
  // –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Å—Ç–∞—è, –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å
  return out;
}
const hash = (s:string)=>require('crypto').createHash('md5').update(s).digest('hex').slice(0,8);

–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ ¬´–≤—Å–µ—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π¬ª (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç/–∏–º–ø–∞–∫—Ç)

// server/routes/analysis-apply-all.ts (–∏–¥–µ—è)
const recs = await getUnappliedRecs(versionId);
recs.sort((a,b) =>
  (a.priority===b.priority?0:a.priority==='high'?-1:1) ||
  (b.score_delta||0)-(a.score_delta||0) ||
  (b.confidence||0)-(a.confidence||0)
);
// –ø—Ä–∏–º–µ–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π diff

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Insights (–∫–∞—Ä–∫–∞—Å)

// server/insights/instagram.ts
export interface InstaMetrics { views:number; reach:number; avg_watch:number; comp_rate:number; saves:number; shares:number; comments:number; }
export async function fetchPostMetrics({ accessToken, postId }:{accessToken:string;postId:string}): Promise<InstaMetrics> {
  // TODO: —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ Graph API (Instagram Business)
  // –≤—Ä–µ–º–µ–Ω–Ω–æ ‚Äî –º–æ–∫ —Å –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞–º–∏
  return { views: 12000, reach: 9500, avg_watch: 8.2, comp_rate: 0.42, saves: 340, shares: 210, comments: 97 };
}


‚∏ª

7) –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å
	‚Ä¢	–ú–æ–¥–µ–ª—å-—Ä–µ–µ—Å—Ç—Ä (–∫–∞–∫ –º—ã —Å–¥–µ–ª–∞–ª–∏) ‚Äî –Ω–∏–∫–∞–∫–∏—Ö ¬´opus-4/sonnet-4-5¬ª.
	‚Ä¢	–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å ‚Äî ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å—ë¬ª –≤—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é script_version, –Ω–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é.
	‚Ä¢	–†–µ–π—Ç–∫–æ–Ω—Ç—Ä–æ–ª—å ‚Äî –∫–Ω–æ–ø–∫–∞ ¬´–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑¬ª –∑–∞—â–∏—â–µ–Ω–∞: –º–∏–Ω–∏–º—É–º N –º–∏–Ω—É—Ç –º–µ–∂–¥—É –∞–Ω–∞–ª–∏–∑–∞–º–∏ –∏–ª–∏ –ª–∏–º–∏—Ç –≤ —Å—É—Ç–∫–∏.
	‚Ä¢	–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å ‚Äî —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞–±–æ—Ä —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π ‚Üí –ø–∏—à–µ–º –≤–µ—Ä—Å–∏—é ‚Üí –ø–æ–º–µ—á–∞–µ–º recs applied=true.
	‚Ä¢	–¢–µ–ª–µ–º–µ—Ç—Ä–∏—è ‚Äî –ª–æ–≥–∏—Ä—É–µ–º agent ‚Üí alias ‚Üí —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π model_id + latency/—Ç–æ–∫–µ–Ω—ã.

‚∏ª

8) –ß—Ç–æ –æ—Ç–¥–∞—é –≤ –±–ª–∏–∂–∞–π—à–∏–π –ø–∞—Ç—á
	‚Ä¢	SQL-–º–∏–≥—Ä–∞—Ü–∏—è (–Ω–æ–≤—ã–µ –ø–æ–ª—è + –¥–≤–µ —Ç–∞–±–ª–∏—Ü—ã)
	‚Ä¢	analysis/agents/* –∫–∞—Ä–∫–∞—Å—ã (5 —à—Ç.)
	‚Ä¢	analysis/architect.ts (–∞–≥—Ä–µ–≥–∞—Ü–∏—è)
	‚Ä¢	3 —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞: reanalyze, apply-all, link insights
	‚Ä¢	UI-–ø—Ä–∞–≤–∫–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞: —á–µ—Ç—ã—Ä–µ –∫–Ω–æ–ø–∫–∏, modal ¬´–ò—Å—Ç–æ—Ä–∏—è¬ª, –±–µ–π–¥–∂–∏, ¬´–º–∞–≥–∏—è¬ª –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

–•–æ—á–µ—à—å ‚Äî –ø—Ä–∏—à–ª—é —Å—Ä–∞–∑—É –¥–∏—Ñ—Ñ-–±–ª–æ–∫–∞–º–∏ –ø–æ–¥ —Ç–≤–æ–∏ —Ñ–∞–π–ª—ã (server/* –∏ client/*), —á—Ç–æ–±—ã —Ç—ã –≤—Å—Ç–∞–≤–∏–ª ¬´–∫–∞–∫ –µ—Å—Ç—å¬ª.