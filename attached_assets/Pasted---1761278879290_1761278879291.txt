–¥–∞, –º—ã —ç—Ç–æ —É–∂–µ –ª–µ—á–∏–ª–∏: –Ω–µ–ª—å–∑—è –¥–∞–≤–∞—Ç—å –∞–≥–µ–Ω—Ç—É —Å–≤–æ–±–æ–¥–Ω–æ –ø–∏—Å–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ –º–æ–¥–µ–ª–µ–π. –ù—É–∂–Ω–æ ¬´–∑–∞–ø–∞—è—Ç—å¬ª –≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ —á–µ—Ä–µ–∑ —Ä–µ–µ—Å—Ç—Ä + –≤–∞–ª–∏–¥–∞—Ü–∏—é –∏ –∂—ë—Å—Ç–∫–∏–π —Ñ–æ–ª–±—ç–∫. –í–æ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π, —Ü–µ–ª—å–Ω—ã–π —Ñ–∏–∫—Å (—Å–∫–æ–ø–∏—Ä—É–π –∫–∞–∫ –µ—Å—Ç—å).

1) –†–µ–µ—Å—Ç—Ä –º–æ–¥–µ–ª–µ–π (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã)

// server/llm/model-registry.ts
export type Provider = 'anthropic'|'openai'|'google';

export type Alias =
  | 'anthropic:sonnet'   // –Ω–∞—à–∞ –¥—Ä—É–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞
  | 'anthropic:haiku'
  | 'openai:gpt4o-mini'
  | 'openai:gpt4.1'
  | 'google:gemini-1.5-pro'
  | 'google:gemini-1.5-flash';

const MAP: Record<Alias, { provider: Provider; id: string }> = {
  'anthropic:sonnet': { provider: 'anthropic', id: 'claude-3-5-sonnet-20240620' },
  'anthropic:haiku':  { provider: 'anthropic', id: 'claude-3-haiku-20240307'   },
  'openai:gpt4o-mini':{ provider: 'openai',    id: 'gpt-4o-mini'               },
  'openai:gpt4.1':    { provider: 'openai',    id: 'gpt-4.1'                   },
  'google:gemini-1.5-pro':   { provider: 'google', id: 'gemini-1.5-pro'        },
  'google:gemini-1.5-flash': { provider: 'google', id: 'gemini-1.5-flash'      },
};

const BLOCKLIST = [
  // —Å—é–¥–∞ —Å–∫–ª–∞–¥—ã–≤–∞–µ–º –≤—Å–µ ¬´—Ñ–∞–Ω—Ç–∞–∑–∏–∏¬ª –∞–≥–µ–Ω—Ç–æ–≤
  'claude-opus-4', 'claude-opus', 'claude-sonnet-4-5', 'opus-4', 'sonnet-4-5',
];

export function resolveModel(alias: Alias) {
  const hit = MAP[alias];
  if (!hit) throw new Error(`Unknown model alias: ${alias}`);
  return hit; // { provider, id }
}

export function assertModelIdSafe(id: string) {
  if (BLOCKLIST.includes(id)) {
    throw new Error(`Blocked model id: ${id}`);
  }
  // –∑–∞—â–∏—Ç–∞: —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ id, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ MAP
  const allowedIds = new Set(Object.values(MAP).map(x => x.id));
  if (!allowedIds.has(id)) {
    throw new Error(`Model id not allowed: ${id}`);
  }
}

2) –û–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ –ê–Ω—Ç—Ä–æ–ø–∏–∫–æ–º (–∏ –¥—Ä—É–≥–∏–º–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏)

// server/llm/anthropic.ts
import Anthropic from '@anthropic-ai/sdk';
import { resolveModel, assertModelIdSafe } from './model-registry';

export async function callAnthropic({
  apiKey,
  prompt,
  alias = 'anthropic:sonnet' as const,
  maxTokens = 1024,
}: { apiKey: string; prompt: string; alias?: 'anthropic:sonnet'|'anthropic:haiku'; maxTokens?: number; }) {
  const { id } = resolveModel(alias);
  assertModelIdSafe(id);

  const client = new Anthropic({ apiKey });
  const rsp = await client.messages.create({
    model: id,
    max_tokens: maxTokens,
    messages: [{ role: 'user', content: prompt }],
  });

  const text = rsp.content.find(c => c.type === 'text')?.text;
  if (!text) throw new Error('No text in Anthropic response');
  return text;
}

3) –§–æ–ª–±—ç–∫, –µ—Å–ª–∏ –∞–≥–µ–Ω—Ç –ø–æ–¥—Å—É–Ω—É–ª ¬´—Å—ã—Ä–æ–π id¬ª

// server/llm/safe-dispatch.ts
import { assertModelIdSafe, resolveModel } from './model-registry';

export function coerceModel(input?: { alias?: string; id?: string }) {
  try {
    if (input?.id) {
      assertModelIdSafe(input.id);
      return { kind: 'id' as const, value: input.id };
    }
    if (input?.alias) {
      const { id } = resolveModel(input.alias as any);
      return { kind: 'id' as const, value: id };
    }
  } catch (e) {
    // –ª–æ–≥–∏—Ä—É–µ–º –∏ –ø–∞–¥–∞–µ–º –Ω–∞ –¥–µ—Ñ–æ–ª—Ç
    console.warn('[LLM] Unsafe model requested, falling back to sonnet', e);
  }
  // –¥–µ—Ñ–æ–ª—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  return { kind: 'id' as const, value: resolveModel('anthropic:sonnet').id };
}

4) –ï–¥–∏–Ω—ã–π –≤—ã–∑–æ–≤ –≤ –∫–æ–¥–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤/–∞–Ω–∞–ª–∏—Ç–∏–∫–∏

–ë–´–õ–û (–ø–ª–æ—Ö–æ):

const message = await anthropic.messages.create({
  model: "claude-opus-4", // –∏–ª–∏ "claude-sonnet-4-5" ü§¶
  ...
});

–°–¢–ê–õ–û (–≤–µ–∑–¥–µ):

import { callAnthropic } from '@/server/llm/anthropic';

const text = await callAnthropic({
  apiKey: process.env.ANTHROPIC_API_KEY!,
  prompt,
  alias: 'anthropic:sonnet', // —Ç–æ–ª—å–∫–æ –∞–ª–∏–∞—Å!
});

5) ¬´–°–∞–Ω–∏—Ç–∞—Ä¬ª –Ω–∞ –∑–∞–ø—É—Å–∫–µ + grep-—Å–∫–∞–Ω–µ—Ä —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞:

// server/bootstrap/model-health.ts
import { resolveModel, assertModelIdSafe } from '@/server/llm/model-registry';

export function assertModelsConfigured() {
  const must = ['anthropic:sonnet','openai:gpt4o-mini'] as const;
  must.forEach(a => assertModelIdSafe(resolveModel(a as any).id));
  console.log('[LLM] Model registry OK');
}

–í—ã–∑–æ–≤–∏ assertModelsConfigured() –≤ bootstrap –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–¥–æ–±–∞–≤—å –≤ package.json):

{
  "scripts": {
    "lint:models": "grep -RInE \"claude-|gpt-|gemini-\" --exclude-dir=node_modules -- *.ts | grep -v \"model-registry\" && (echo '‚ùå Found hardcoded model ids'; exit 1) || echo '‚úÖ No hardcoded model ids'"
  }
}

–¢–µ–ø–µ—Ä—å CI/–ø—Ä–µ—Ö—É–∫ —Ä—É–±–∏—Ç –ª—é–±–æ–µ –ø—Ä—è–º–æ–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ claude-*/gpt-*/gemini-* –≤–Ω–µ —Ä–µ–µ—Å—Ç—Ä–∞.

6) –õ–æ–≥–∏ –∏ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è

–ü—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ –ª–æ–≥–∏—Ä—É–π –∞–ª–∏–∞—Å –∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π id:

[LLM] provider=anthropic alias=anthropic:sonnet id=claude-3-5-sonnet-20240620

–ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç ¬´opus/4-5¬ª ‚Äî —É–≤–∏–¥–∏—à—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ —Ñ–æ–ª–±—ç–∫.

7) –ß—Ç–æ –ø–æ–º–µ–Ω—è—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
	‚Ä¢	–ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ –ø—Ä—è–º—ã–µ model: "..." –Ω–∞ –≤—ã–∑–æ–≤—ã —á–µ—Ä–µ–∑ callAnthropic/registry.
	‚Ä¢	–î–æ–±–∞–≤–∏—Ç—å lint:models –≤ CI/–ø—Ä–µ—Ö—É–∫.
	‚Ä¢	–í –º–µ—Å—Ç–∞—Ö, –≥–¥–µ –∞–≥–µ–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—Ç –º–æ–¥–µ–ª—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏, –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∞–ª–∏–∞—Å—ã (anthropic:sonnet, openai:gpt4o-mini), –Ω–∏–∫–æ–≥–¥–∞ ¬´—Å—ã—Ä–æ–π id¬ª.
	‚Ä¢	–£–±—Ä–∞—Ç—å –ª—é–±—ã–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è claude-opus-4, claude-sonnet-4-5 ‚Äî –æ–Ω–∏ –ø–æ–ø–∞–¥—É—Ç –≤ BLOCKLIST.

‚∏ª

–ü–æ—á–µ–º—É —ç—Ç–æ —É—Å—Ç—Ä–∞–Ω–∏—Ç –±–∞–≥ ¬´–µ—â—ë —Ä–∞–∑¬ª
	‚Ä¢	–ê–≥–µ–Ω—Ç –±–æ–ª—å—à–µ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–º–µ–Ω—è—Ç—å —Å—Ç—Ä–æ–∫—É –º–æ–¥–µ–ª–∏ ‚Äî –ª–∏—à—å –∞–ª–∏–∞—Å –∏–∑ ¬´–±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞¬ª.
	‚Ä¢	–î–∞–∂–µ –µ—Å–ª–∏ –∫—Ç–æ-—Ç–æ –ø—Ä–æ–±—Ä–æ—Å–∏–ª id, assertModelIdSafe –∑–∞—Ä—É–±–∏—Ç.
	‚Ä¢	–ü—Ä–∏ –ª—é–±–æ–π –Ω–µ—à—Ç–∞—Ç–∫–µ ‚Äî —Ñ–æ–ª–±—ç–∫ –Ω–∞ anthropic:sonnet + —è–≤–Ω—ã–π –ª–æ–≥.

–•–æ—á–µ—à—å ‚Äî —Å–≥–µ–Ω–µ—Ä—é –ø–∞—Ç—á-–¥–∏–¥–∂–µ—Å—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ (—Å–∫–∞–∂–∏ –≥–¥–µ —Å–µ–π—á–∞—Å –≤—ã–∑—ã–≤–∞—é—Ç—Å—è Anthropic/OpenAI), —á—Ç–æ–±—ã —Ç—ã –ø—Ä–∏–º–µ–Ω–∏–ª ¬´–∫–∞–∫ –µ—Å—Ç—å¬ª.