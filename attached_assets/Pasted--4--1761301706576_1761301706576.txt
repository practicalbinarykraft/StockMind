Отлично, что поймал это сейчас. У тебя одновременно 4 проблемы: автозапуск анализа, язык/перевод, «применить» уводит в цикл, и нестабильная рекомендация (скачет формат). Ниже — точный разбор, почему так и как починить без ломки архитектуры (всё в рамках Stage 3, за фича-флагом).

⸻

Что не так (по факту, по логам UX)
	1.	Анализ стартует сам
Причина: в stage-3-ai-analysis.tsx есть useEffect/useQuery, который дергает /analyze-source при маунте. Поэтому ты видишь спиннер сразу.
	2.	Язык/перевод неуправляемы
— Источник на EN, UI показывает «Язык: RU», но контент и ключевые слова — EN.
— Нет кнопки «Перевести статью»/«Писать сценарий на русском» — и пользователь не понимает, что будет дальше.
	3.	Нажал “Применить рекомендованный” → белый экран → опять «Анализируем исходник»
Это явный цикл: после нажатия мы не переключаемся в режим «Script Editor», а снова дергаем /analyze-source.
Скорее всего:

	•	клиент зовет не тот эндпоинт (или не ждет завершения),
	•	сервер не создает v1 в script_versions (или не помечает «current»),
	•	дальше Stage 3 по условию “скрипта нет → анализ исходника” снова запускает анализ.

	4.	Рекомендованный формат поменялся сам
Потому что второй/третий вызов /analyze-source происходит заново → LLM-недетерминизм → другая рекомендация.

⸻

Как должно быть (Stage 3 = один экран, два устойчивых режима)

Режим A: Source Review
	•	Кнопки:
	•	«Показать статью»
	•	«Перевести на RU» (или выбранный язык)
	•	«Начать анализ» (если автоанализ выключен)
	•	После анализа: карточка рекомендаций + «Применить рекомендованный»/«Выбрать другой».

Режим B: Script Editor
	•	Генерация сценария создаёт v1 в script_versions и переводит UI в редактор (без возврата к анализу исходника).
	•	Далее — рекомендации, Apply/Apply All, История.

⸻

Исправляем точечно (без ломки пайплайна)

1) Контролируем запуск анализа (без автостартов)
	•	Включаем флаг (по умолчанию выкл):
	•	VITE_STAGE3_AUTO_ANALYZE=false
	•	В компоненте Stage 3:
	•	Убираем автоматический вызов анализа при маунте.
	•	Добавляем кнопку «Начать анализ» (видна, если анализа ещё нет).
	•	Если хочешь оставить автозапуск как опцию — уважай флаг:
	•	if (import.meta.env.VITE_STAGE3_AUTO_ANALYZE === 'true') triggerAnalyze()

Мини-патч (идея):

// раньше: useEffect(() => runAnalyze(), [])
// теперь:
const auto = import.meta.env.VITE_STAGE3_AUTO_ANALYZE === 'true';
useEffect(() => { if (auto && !analysis) triggerAnalyze(); }, [auto, analysis]);

// кнопка:
<Button onClick={triggerAnalyze} disabled={isAnalyzing}>
  {isAnalyzing ? 'Анализируем…' : 'Начать анализ'}
</Button>

2) Язык: явная настройка + перевод источника
	•	В SourceSummaryBar/Modal добавляем:
	•	«Язык источника: EN» (детект)
	•	Toggle: «Писать сценарий на: RU | EN …» (сохраняем в project.config.targetLocale)
	•	Кнопку «Перевести статью на RU» → /translate-source (сервер хранит translated_text рядом с оригиналом).
	•	Анализ и рекомендация всегда получают targetLocale и генерят вывод на выбранном языке.
(И ключевые слова/темы — тоже в targetLocale.)

API (новенькое, простое):
	•	POST /api/projects/:id/translate-source { targetLocale } → { textTranslated, langDetected }
	•	POST /api/projects/:id/analyze-source { targetLocale, useTranslated?: boolean }
	•	POST /api/projects/:id/generate-script { targetLocale, format }

3) “Применить рекомендованный” → гарантия перехода в Script Editor

Суть: строгое состояние + идемпотентность.
	•	Сервер в POST /generate-script делает ТРИ обязательных шага:
	1.	Пишет запись в script_versions (v1, is_current=true, provenance={source:'initial', agent:'architect'}).
	2.	В project_steps помечает Stage 3 как script_ready=true.
	3.	Возвращает { versionId, scenes, versionNumber: 1 }.
	•	Клиент:
	•	Ждет 200 → refetch(['script-history']) → форсирует режим Script Editor:
	•	setMode('script')
	•	отключает любые useEffect, которые могли бы снова дернуть /analyze-source.
	•	Показывает тост: «Сценарий создан • v1».

Мини-патч (идея):

const applyRecommended = async () => {
  setApplying(true);
  const res = await api.post(`/api/projects/${id}/generate-script`, { format, targetLocale });
  await queryClient.invalidateQueries(['script-history', id]);
  setMode('script'); // <- ключевой момент
  setApplying(false);
};

4) Фикс «скачущей» рекомендации
	•	Кэшируем результат анализа исходника (чтобы не дергать LLM повторно без причины):
	•	В project_steps.stage3_source_analysis храним { analysis, recommendedFormat, createdAt, locale }.
	•	Повторно пересчитываем только по кнопке «Пересчитать анализ» или при смене языка.
	•	На клиенте — useQuery с staleTime + проверка: если анализ есть в БД/кэше — показываем его, не трогаем API.

⸻

Что сказать Replit (готовое ТЗ)

Frontend (Stage 3):
	1.	Убрать автоанализ при открытии (уважать VITE_STAGE3_AUTO_ANALYZE=false).
	2.	Добавить в SourcePreview:
	•	детект языка источника,
	•	селектор «Писать сценарий на…»,
	•	кнопка «Перевести статью на …».
	3.	В блоке анализа:
	•	кнопка «Начать анализ» (если анализа нет),
	•	«Пересчитать анализ» (если пользователь хочет).
	4.	Кнопка «Применить рекомендованный»:
	•	вызывает /generate-script,
	•	ждёт ответ → refetch(script-history) → переключает режим в Script Editor (никаких повторных анализов).
	5.	Закрепить режимы:
	•	если script_versions есть → всегда «Script Editor»;
	•	если нет → «Source Review» без автостартов.

Backend:
	1.	POST /api/projects/:id/translate-source { targetLocale }
	•	сохраняет translated_text рядом с источником.
	2.	POST /api/projects/:id/analyze-source { targetLocale, useTranslated }
	•	проверяет кэш в БД; если есть и ещё валиден — возвращает его; иначе — считает и кэширует.
	3.	POST /api/projects/:id/generate-script { format, targetLocale }
	•	генерирует сценарий, создаёт v1 в script_versions, помечает is_current=true, возвращает версию.
	4.	Все ответы содержат targetLocale, чтобы UI уверенно подписывал «Язык вывода: RU».

Доп. косметика (быстро):
	•	В левом сайдбаре под «Source Selection» показать бейдж «News»/«Reel»/«Custom».
	•	В SourceSummaryBar — «Язык источника: EN • Язык вывода: RU».
	•	Если источник EN и перевод не сделан — выводить незаметный инфо-блок: «Рекомендуем перевести статью, чтобы анализ и подсказки были на русском».

⸻

Почему это безопасно и не сломает флоу
	•	Всё остаётся в рамках Stage 3 и твоего текущего фича-флага.
	•	Никаких опасных миграций схемы — максимум поля для кэша анализа (можно даже положить в project_steps JSONB).
	•	Чёткая машина состояний: Source Review ↔ Script Editor.
	•	Идемпотентность и кэш снимают «скачки формата» и двойные вызовы.

⸻

Короткий чек-лист для тестов
	•	Создать проект → выбрать News.
	•	Убедиться, что анализ не стартует сам.
	•	Открыть статью → нажать «Перевести на RU».
	•	Нажать «Начать анализ» → получить карточку с рекомендацией.
	•	Нажать «Применить рекомендованный» → через 1 ответ сразу попасть в Script Editor (v1).
	•	Обновить страницу — остаёмся в Script Editor, никаких повторных анализов.
	•	Вернуться назад к Stage 3 — анализ не дергается сам; «Пересчитать» работает по кнопке.

Если хочешь, могу выписать конкретные строчки в stage-3-ai-analysis.tsx, куда положить setMode('script') и где снять автозапуск — скажи на какой ветке работаешь.