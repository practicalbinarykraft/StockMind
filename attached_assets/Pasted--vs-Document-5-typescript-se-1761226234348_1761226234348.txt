üîç –°–†–ê–í–ù–ï–ù–ò–ï –ö–û–î–ê: –°–¢–ê–†–´–ô vs –ù–û–í–´–ô
üìä –ö–õ–Æ–ß–ï–í–´–ï –û–¢–õ–ò–ß–ò–Ø:
–°–¢–ê–†–´–ô –ü–†–û–ï–ö–¢ (Document 5) ‚úÖ
typescript// server/apify-service.ts

‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:
   - mapApifyReel() —Å safe number conversion
   - Float ‚Üí Integer (Math.round)
   - isFinite() validation
   - Safe defaults

‚úÖ –§—É–Ω–∫—Ü–∏—è –¥–ª—è refresh:
   - fetchSingleReelData(shortCode)
   - –ü–æ–ª—É—á–∞–µ—Ç fresh videoUrl –∫–æ–≥–¥–∞ URL –∏—Å—Ç–µ–∫–∞–µ—Ç

‚úÖ Mutual recovery:
   - shortCode ‚Üî URL –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
   - –ï—Å–ª–∏ –Ω–µ—Ç shortCode, –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏–∑ URL
   - –ï—Å–ª–∏ –Ω–µ—Ç URL, —Å—Ç—Ä–æ–∏—Ç –∏–∑ shortCode

‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
   - Sample fields
   - Duration normalization
   - Field discovery

‚úÖ Multiple duration fields:
   - videoDuration ?? durationInSeconds ?? duration

–ù–û–í–´–ô –ü–†–û–ï–ö–¢ (Document 6) ‚ö°
typescript// server/apify-service.ts

‚úÖ Timeouts:
   - 3 –º–∏–Ω—É—Ç—ã –¥–ª—è scraping
   - 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è dataset fetch
   - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–µ

‚úÖ API Key –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä:
   - scrapeInstagramReels(username, apiKey, limit)
   - –ë–æ–ª–µ–µ –≥–∏–±–∫–æ (–Ω–µ —Ç–æ–ª—å–∫–æ env)

‚úÖ Structured —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
   - ApifyScrapingResult —Å success/error
   - –ß–µ—Ç–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞

‚úÖ Test —Ñ—É–Ω–∫—Ü–∏—è:
   - testApifyApiKey()
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–ª—é—á–∞

‚ùå –ù–ï–¢ safe number conversion
‚ùå –ù–ï–¢ fetchSingleReelData()
‚ùå –ù–ï–¢ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ float ‚Üí int
‚ùå –ù–ï–¢ mutual recovery
‚ùå –ú–µ–Ω—å—à–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

üî¥ –ö–†–ò–¢–ò–ß–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –í –ù–û–í–û–ú:
1. NO SAFE NUMBER CONVERSION
typescript// –ù–æ–≤—ã–π –∫–æ–¥ (–û–ü–ê–°–ù–û):
likesCount: item.likesCount || 0,
videoViewCount: item.videoViewCount,
videoDuration: item.videoDuration,

// –ü—Ä–æ–±–ª–µ–º–∞:
// –ï—Å–ª–∏ Apify –≤–µ—Ä–Ω—ë—Ç 45.7 —Å–µ–∫—É–Ω–¥ ‚Üí –ë–î –ø–æ–ª—É—á–∏—Ç float!
// PostgreSQL integer –ø–æ–ª–µ –ù–ï –ø—Ä–∏–º–µ—Ç float!
–°—Ç–∞—Ä—ã–π –∫–æ–¥ (–ü–†–ê–í–ò–õ–¨–ù–û):
typescriptconst safeNumber = (value: any, defaultValue: number = 0): number => {
  const num = Number(value);
  return isFinite(num) && num >= 0 ? Math.round(num) : defaultValue;
};

videoDuration: safeNumber(rawDuration, 0),
likesCount: safeNumber(reel.likesCount, 0),

2. NO fetchSingleReelData()
typescript// –°—Ç–∞—Ä—ã–π –ø—Ä–æ–µ–∫—Ç –ò–ú–ï–õ:
async function fetchSingleReelData(shortCode: string)

// –ó–∞—á–µ–º –Ω—É–∂–Ω–æ?
// - Instagram video URLs –∏—Å—Ç–µ–∫–∞—é—Ç —á–µ—Ä–µ–∑ 24-48 —á–∞—Å–æ–≤
// - –î–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –Ω—É–∂–µ–Ω —Å–≤–µ–∂–∏–π URL
// - Refresh –±–µ–∑ full re-parse
–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –ù–ï –ò–ú–ï–ï–¢ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é!

3. NO MUTUAL RECOVERY
typescript// –°—Ç–∞—Ä—ã–π –∫–æ–¥ (SMART):
let shortCode = item.shortCode || '';
let url = item.url || '';

// –ï—Å–ª–∏ –Ω–µ—Ç shortCode, –∏–∑–≤–ª–µ—á—å –∏–∑ URL
if (!shortCode && url) {
  const match = url.match(/\/(?:reel|p)\/([A-Za-z0-9_-]+)/);
  if (match) shortCode = match[1];
}

// –ï—Å–ª–∏ –Ω–µ—Ç URL, –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –∏–∑ shortCode
if (shortCode && !url) {
  url = `https://www.instagram.com/reel/${shortCode}/`;
}

// –ù–æ–≤—ã–π –∫–æ–¥: –ù–ï–¢ —ç—Ç–æ–π –ª–æ–≥–∏–∫–∏!

‚úÖ –ß–¢–û –•–û–†–û–®–û –í –ù–û–í–û–ú:
1. TIMEOUTS
typescriptfunction withTimeout<T>(
  promise: Promise<T>, 
  timeoutMs: number, 
  errorMessage: string
): Promise<T> {
  return Promise.race([
    promise,
    new Promise<T>((_, reject) =>
      setTimeout(() => reject(new Error(errorMessage)), timeoutMs)
    ),
  ]);
}

// Usage:
await withTimeout(
  client.actor('...').call(input),
  180000, // 3 minutes
  'Timeout!'
);
–≠—Ç–æ –û–¢–õ–ò–ß–ù–û! –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–µ!

2. STRUCTURED RESULT
typescriptinterface ApifyScrapingResult {
  success: boolean;
  items: InstagramReelData[];
  error?: string;
  itemCount: number;
}

// Caller –∑–Ω–∞–µ—Ç —É—Å–ø–µ—Ö/–Ω–µ—É–¥–∞—á—É
const result = await scrapeInstagramReels(...);
if (!result.success) {
  console.error(result.error);
}
–≠—Ç–æ –•–û–†–û–®–û! –ß–µ—Ç–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞!

3. TEST FUNCTION
typescriptasync function testApifyApiKey(apiKey: string): Promise<boolean> {
  try {
    const client = new ApifyClient({ token: apiKey });
    await client.actor('apify/instagram-reel-scraper').get();
    return true;
  } catch {
    return false;
  }
}
–≠—Ç–æ –ü–û–õ–ï–ó–ù–û! –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ use!

üéØ –ò–î–ï–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï:
–û–ë–™–ï–î–ò–ù–ò–¢–¨ –õ–£–ß–®–ï–ï –ò–ó –û–ë–û–ò–•!
typescript// server/apify-service.ts (HYBRID)

import { ApifyClient } from 'apify-client';

// ‚úÖ –û—Ç –Ω–æ–≤–æ–≥–æ: Timeout helper
function withTimeout<T>(
  promise: Promise<T>,
  timeoutMs: number,
  errorMessage: string
): Promise<T> {
  return Promise.race([
    promise,
    new Promise<T>((_, reject) =>
      setTimeout(() => reject(new Error(errorMessage)), timeoutMs)
    ),
  ]);
}

// ‚úÖ –û—Ç —Å—Ç–∞—Ä–æ–≥–æ: Safe number conversion
function safeNumber(value: any, defaultValue: number = 0): number {
  const num = Number(value);
  return isFinite(num) && num >= 0 ? Math.round(num) : defaultValue;
}

// ‚úÖ –û—Ç —Å—Ç–∞—Ä–æ–≥–æ: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å safe types
function mapApifyReel(reel: any, shortCodeFallback?: string) {
  let shortCode = reel.shortCode || shortCodeFallback || '';
  let url = reel.url || '';

  // ‚úÖ –û—Ç —Å—Ç–∞—Ä–æ–≥–æ: Mutual recovery
  if (!shortCode && url) {
    const match = url.match(/\/(?:reel|p)\/([A-Za-z0-9_-]+)/);
    if (match) shortCode = match[1];
  }

  if (shortCode && !url) {
    url = `https://www.instagram.com/reel/${shortCode}/`;
  }

  // ‚úÖ –û—Ç —Å—Ç–∞—Ä–æ–≥–æ: Safe integers –¥–ª—è –ë–î
  const rawDuration = reel.videoDuration ?? reel.durationInSeconds ?? reel.duration ?? 0;
  const normalizedDuration = safeNumber(rawDuration, 0);

  return {
    shortCode,
    url,
    caption: (reel.caption || '').trim(),
    videoUrl: reel.videoUrl || '',
    thumbnailUrl: reel.thumbnailUrl || reel.displayUrl || '',
    videoViewCount: safeNumber(reel.videoViewCount || reel.videoPlayCount, 0),
    likesCount: safeNumber(reel.likesCount, 0),
    commentsCount: safeNumber(reel.commentsCount, 0),
    videoDuration: normalizedDuration,
    timestamp: reel.timestamp || null,
    // ... other fields
  };
}

// ‚úÖ –û—Ç –Ω–æ–≤–æ–≥–æ: Structured result + timeouts
export async function scrapeInstagramReels(
  username: string,
  apiKey: string,
  resultsLimit: number = 50
): Promise<ApifyScrapingResult> {
  try {
    const client = new ApifyClient({ token: apiKey });

    const run = await withTimeout(
      client.actor('apify/instagram-reel-scraper').call({
        username: [username],
        resultsLimit,
      }),
      180000, // 3 min timeout
      `Timeout for user: ${username}`
    );

    const { items } = await withTimeout(
      client.dataset(run.defaultDatasetId).listItems(),
      30000, // 30 sec timeout
      `Dataset timeout for user: ${username}`
    );

    // ‚úÖ –û—Ç —Å—Ç–∞—Ä–æ–≥–æ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å mapApifyReel —Å safe conversion
    const transformedItems = items.map((item: any) => 
      mapApifyReel(item)
    );

    return {
      success: true,
      items: transformedItems,
      itemCount: transformedItems.length,
    };
  } catch (error) {
    return {
      success: false,
      items: [],
      error: error.message,
      itemCount: 0,
    };
  }
}

// ‚úÖ –û—Ç —Å—Ç–∞—Ä–æ–≥–æ: Refresh function –¥–ª—è expired URLs
export async function fetchSingleReelData(
  shortCode: string,
  apiKey: string
): Promise<InstagramReelData | null> {
  try {
    const client = new ApifyClient({ token: apiKey });
    
    const run = await withTimeout(
      client.actor('apify/instagram-reel-scraper').call({
        directUrls: [`https://www.instagram.com/reel/${shortCode}/`],
        resultsLimit: 1,
      }),
      60000, // 1 min timeout
      `Timeout fetching reel: ${shortCode}`
    );

    const { items } = await client.dataset(run.defaultDatasetId).listItems();
    
    if (!items || items.length === 0) return null;

    return mapApifyReel(items[0], shortCode);
  } catch (error) {
    console.error('[Apify] Error fetching single reel:', error);
    throw error;
  }
}

// ‚úÖ –û—Ç –Ω–æ–≤–æ–≥–æ: Test function
export async function testApifyApiKey(apiKey: string): Promise<boolean> {
  try {
    const client = new ApifyClient({ token: apiKey });
    await client.actor('apify/instagram-reel-scraper').get();
    return true;
  } catch {
    return false;
  }
}
```

---

## ‚ö° –ß–¢–û –°–ö–ê–ó–ê–¢–¨ AGENT:
```
Agent, compare your new code with old project!

PROBLEMS in your implementation:

1. NO SAFE NUMBER CONVERSION:
   videoDuration might be float (45.7 seconds)
   But database expects INTEGER
   Will cause DB errors!
   
   OLD project had:
   safeNumber() with Math.round() and isFinite() check

2. NO fetchSingleReelData() function:
   Instagram video URLs expire in 24-48 hours
   Need to refresh URL before transcription
   
   OLD project had:
   fetchSingleReelData(shortCode) to get fresh URL

3. NO MUTUAL RECOVERY:
   If shortCode missing, extract from URL
   If URL missing, build from shortCode
   
   OLD project had this logic

GOOD things in your code:
‚úÖ withTimeout() helper
‚úÖ Structured ApifyScrapingResult
‚úÖ testApifyApiKey() function
‚úÖ apiKey as parameter (flexible)

SOLUTION: Merge both approaches!

Please update server/apify-service.ts:
1. Add safeNumber() function from old project
2. Add mapApifyReel() with safe conversion
3. Add fetchSingleReelData() for URL refresh
4. Keep your timeout logic
5. Keep your structured result
6. Add mutual recovery for shortCode ‚Üî URL

This combines best of both worlds!
Critical for database integrity!
```

---

## üìã SUMMARY:
```
–°—Ç–∞—Ä—ã–π –ø—Ä–æ–µ–∫—Ç:
‚úÖ Safe number conversion (critical!)
‚úÖ fetchSingleReelData() (needed!)
‚úÖ Mutual recovery
‚úÖ Detailed logging
‚ùå No timeouts
‚ùå No test function

–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç:
‚úÖ Timeouts (excellent!)
‚úÖ Structured result
‚úÖ Test function
‚úÖ Flexible apiKey param
‚ùå No safe conversion (critical bug!)
‚ùå No refresh function
‚ùå No mutual recovery

IDEAL: Combine both! üéØ

AGENT –î–û–õ–ñ–ï–ù –û–ë–™–ï–î–ò–ù–ò–¢–¨ –û–ë–ê –ü–û–î–•–û–î–ê! üîß
–ö–†–ò–¢–ò–ß–ù–û: –î–û–ë–ê–í–ò–¢–¨ SAFE NUMBER CONVERSION! üî¥