Да, давай к тестам. Вот короткий чек-лист, чтобы быстро подтвердить все фиксы без сюрпризов.

Смоук-план (по шагам и ожидаемым результатам)
	1.	Создать/открыть проект → Stage 3 (Редактор)

	•	Ожидаемо: сверху баннер «Кандидат доступен» появляется только если есть candidate.
	•	В карточках сцен виден текущий текст кандидата (если он есть).

	2.	Нажать «Анализ сценария»

	•	Прогресс: Hook → Structure → Emotion → CTA → Synthesis.
	•	Результат: в правом блоке «Инструменты» показаны рекомендации именно для activeVersion (candidate>current), в тосте — «Рекомендации загружены: N сцен».

	3.	«Применить рекомендацию» на 1–2 сценах

	•	Сцены получают бейдж «Изменена».
	•	Кнопка «Сохранить новую версию» становится активной.

	4.	«Сохранить новую версию»

	•	Ожидаемо: создаётся candidate vN+1, редактор сразу показывает его (кэш обновился).
	•	В баннере доступны: «Сравнить», «Принять», «Отменить».

	5.	«Сравнить версии»

	•	Вкладка «Сцены»: слева ДО (базовая), справа ПОСЛЕ (кандидат) — тексты разные там, где применяли.
	•	Вкладка «Метрики»: общий балл и разбиения корректны (hook из breakdown, structure/emotional/cta — с верхнего уровня; не нули).

	6.	«Принять новую версию»

	•	Candidate становится current; баннер исчезает.
	•	Правый блок продолжает показывать данные уже принятой версии.

	7.	«Перейти к озвучке»

	•	Если анализ ещё крутится: не блокируем, показываем предупреждение-тост и даём продолжить.
	•	Переход на Stage 4 без ошибок.

	8.	JSON-устойчивость

	•	Во время анализа не должно упасть с «Expected ‘,’ …»; если LLM вернёт кривой JSON, всё чинится автоматически (repair+retry).
	•	Логи чистые (без LLM_JSON_PARSE_FAILED).

	9.	Старые проекты / авторизация

	•	Открытие старого проекта: либо нормальная загрузка, либо понятный редирект/сообщение (401 → логин, 404 → «Проект не найден»).
	•	Кнопка «На главную» всегда работает.

Если что-то пойдёт не так
	•	Рекомендации «не те»: проверь, что в правой панели ключ запросов включает activeVersionId, а не currentVersionId.
	•	Баллы по зонам = 0: ещё раз глянь маппинг метрик (structure/emotional/cta ← верхний уровень).
	•	Сравнение показывает одинаковые тексты: убедись, что candidate действительно обновился (в баннере «Принять/Отменить» есть) и кэш инвалидируется по ключам с exact: false.
