Ты всё правильно чувствуешь: сейчас в Stage 3 «в одну кнопку» смешаны два разных действия — анализ текущего сценария и генерация новой версии для сравнения. Из-за этого ты ждёшь рекомендации, а вместо них запускается тяжёлая асинхронная «перегенерация» (черновик), которая ещё и может упасть по таймауту. Ниже — понятное разделение логики + короткое ТЗ для реплита, чтобы привести UX в порядок.

Как должно работать (простыми словами)
	•	Анализ сценария = быстро оценить текущую версию: баллы по сценам, разбор хуков/структуры/эмоций/CTA, рецензия AI-архитектора, список точечных рекомендаций с кнопками «Применить».
	•	Черновик для сравнения (ДО/ПОСЛЕ) = медленная штука: ИИ сам применяет ряд улучшений и создаёт новую версию («ПОСЛЕ») для сравнения с текущей («ДО»). Потом ты открываешь модалку «ДО/ПОСЛЕ» и выбираешь одну.

Это два разных процесса и они должны быть двумя разными кнопками.

⸻

ТЗ для реплита

1) Кнопки и тексты (UI/UX)

Правая панель «Инструменты», Stage 3:
	1.	Основная кнопка (синяя):
«Анализ сценария»
	•	Описание под кнопкой: «Оценим качество текущей версии и дадим рекомендации по каждой сцене».
	2.	Вторичная кнопка:
«Создать черновик (ДО/ПОСЛЕ)»
	•	Описание под кнопкой: «ИИ подготовит улучшенную версию для сравнения. Процесс займёт ~10–90 сек».
	3.	Кнопка сравнения (появляется только если есть черновик):
«Открыть сравнение (ДО/ПОСЛЕ)»
	4.	Кнопка отмены (видна только пока идёт подготовка черновика):
«Отменить черновик»
	5.	История версий:
«Все версии (история)» (как сейчас).

2) Поведение кнопок

А) «Анализ сценария» (быстрый синхронный/квази-синхронный поток)
	•	При клике: disabled + мини-спиннер на кнопке (не модалка, не оверлей).
	•	Запрашивает анализ только для текущей версии (без создания кандидата).
	•	Через 3–20 сек отображаем:
	•	Вверху блока каждой сцены: бейдж с баллами и значками проблем (hook/structure/emotional/cta).
	•	Под сценой: «Рекомендации AI» со списком карточек и кнопками «Применить рекомендацию» / «Улучшить всё» (как у тебя уже было).
	•	В конце списка сцен: «Рецензия AI-архитектора» (сводка + прогноз).
	•	Выводим тост «Анализ готов. Рекомендации доступны под сценами» (без задержек).

Б) «Создать черновик (ДО/ПОСЛЕ)» (асинхронный поток)
	•	Никакого анализа текущей версии не запускает. Только создаёт улучшенную кандидатную версию.
	•	Вверху — карточка прогресса (как уже сделали), шаги: Инициализация → Hook → Structure → Emotional → CTA → Синтез/Сохранение.
(Экспоненциальные ретраи у вас уже есть — ок.)
	•	По завершении:
	•	Появляется синяя кнопка «Открыть сравнение (ДО/ПОСЛЕ)».
	•	Тост с action-кнопкой «Открыть сейчас».
	•	В модалке сравнения:
	•	Вкладка «Метрики» (общий балл + 4 зоны + рецензии архитектора + дельты).
	•	Вкладка «Сцены» (ДО/ПОСЛЕ построчно, подсветка изменений).
	•	Кнопки: «Оставить ДО» / «Выбрать ПОСЛЕ».
После выбора — модалка закрывается, «Открыть сравнение» пропадает.

В) «Отменить черновик»
	•	Отменяет текущую job (DELETE endpoint уже есть).
	•	Статус-карточка исчезает, кнопка «Открыть сравнение» не показывается.

3) Эндпоинты (API)

Новые/уточнённые:
	•	POST /api/projects/:id/analysis/start
Body: { scriptVersionId }
Ответ: { jobId } (если делаете как async) или сразу { success:true, data: AnalysisPayload } (если делаете квази-синхронно).
	•	GET /api/projects/:id/analysis/status/:jobId (если выбрали async)
Ответ: { status: 'queued'|'running'|'done'|'error', step, progress, data? }
	•	GET /api/projects/:id/analysis/latest?scriptVersionId=...
Ответ: { success:true, data: { breakdown, perSceneRecommendations[], architectReview, overallScore, predictedMetrics } }
	•	POST /api/projects/:id/reanalyze/start (как сейчас, создаёт candidate)
	•	GET /api/projects/:id/reanalyze/status/:jobId (как сейчас)
	•	GET /api/projects/:id/reanalyze/compare/latest (как сейчас, но убеждаемся, что отдаёт и scenes, и review, и breakdown)
	•	POST /api/projects/:id/reanalyze/compare/choose (как сейчас)
	•	DELETE /api/projects/:id/reanalyze/candidate (как сейчас — отмена черновика)

Важно: анализ и черновик не должны зависеть друг от друга. Анализ — поверх текущей версии; черновик — создаёт новую.

4) Ошибки и таймауты
	•	Анализ сценария — не должен зависеть от 2-минутного таймаута «черновика».
Если >60 сек: показываем подсказку «Дольше обычного, продолжаем» и продолжаем поллинг до done/error. Не падаем тостом «пересчёт занял слишком долго».
	•	Черновик — оставляем текущую стратегию (exponential backoff, до 120–180 сек), но при error/timeout явно пишем:
«Не удалось подготовить черновик. Попробуйте ещё раз или нажмите “Анализ сценария”, чтобы получить рекомендации без сравнения».

5) Копирайтинг (сразу заменить)
	•	«Черновик для сравнения» → «Создать черновик (ДО/ПОСЛЕ)»
	•	«Пересчёт сценария» (баннер) → если job = reanalyze, писать «Готовим черновик для сравнения…»; если job = analysis, писать «Выполняем анализ сценария…».
	•	В тостах всегда указывать тип операции: [Анализ] или [Черновик].

6) Перевод заголовка
	•	Исправить пайплайн перевода: переводить и title источника, и summary.
Поля: source.title_ru и/или analysis.sourceTitleTranslated — и использовать их в UI в диалоге «Показать статью».

7) Acceptance Criteria (что считаем готовым)
	•	После генерации сценария пользователь видит кнопку «Анализ сценария»; по клику через ≤30 сек под сценами появляются баллы и рекомендации; доступна рецензия AI-архитектора.
	•	Кнопка «Создать черновик (ДО/ПОСЛЕ)» не запускает анализ; по завершении доступна модалка с вкладками Метрики/Сцены и кнопками выбора версии.
	•	Таймаут черновика не ломает оценку сцен и рекомендации. Кнопка «Анализ сценария» работает независимо.
	•	Заголовок статьи корректно переводится при включённом переводе.
	•	Все тексты/тосты понятны и единообразны.

⸻

Куда нажимать тебе сейчас
	•	Для рекомендаций по текущей версии — нужна кнопка «Анализ сценария» (её добавят по ТЗ).
Пока её нет — рекомендации появляются только внутри потока «черновика», что и сбивает.

Если хочешь, я превращу это ТЗ в короткий чек-лист задач для реплита (по файлам/компонентам) — скажи, сделаю.