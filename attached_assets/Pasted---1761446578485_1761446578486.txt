Окей, давай разрулим путаницу и заодно выдадим реплиту чёткое, короткое и проверяемое ТЗ.

⸻

Что у тебя сейчас происходит (по скринам)
	1.	Ты выбрал «ПОСЛЕ» → кандидат стал текущей версией (v9).
	2.	Кнопка «Открыть сравнение (ДО/ПОСЛЕ)» пропала — это нормально: сравнивать больше не с чем, черновика нет.
	3.	Кнопка «История изменений» теперь называется «Все версии (история)» — там архив v1…vN (как на твоём скрине).
	4.	При попытке «Создать черновик для сравнения» иногда вылетает таймаут «не завершилось за 70 секунд» — так быть не должно; нужен стабильный асинхронный джоб с прогрессом/повторами и понятными статусами.

⸻

Простая модель этапа 3 (чтобы всем было ясно)

Состояния проекта на этапе «AI Analysis / Редактор сценария»:
	•	S0. Нет черновика (текущая версия = последняя сохранённая).
	•	S1. Черновик в очереди/процессе (идёт перерасчёт).
	•	S2. Черновик готов (есть кандидат для сравнения).
	•	S3. Черновик принят → становится новой текущей версией (возврат в S0).
	•	S4. Черновик отменён → откат в S0 без изменений.

UI-кнопки по состояниям:
	•	S0: «Создать черновик для сравнения» • «Все версии (история)».
	•	S1: «Пересчёт сценария…» (панель с прогрессом, кнопка «Отменить черновик»). Кнопка создания черновика неактивна.
	•	S2: «Открыть сравнение (ДО/ПОСЛЕ)» • «Отменить черновик».
	•	S3/S4: возвращаемся к S0.

⸻

ТЗ для реплита (бэкенд + фронт) — коротко и по делу

1) Эндпоинты (контракты)

POST /api/projects/:id/reanalyze/start
	•	Request: { idempotencyKey?: string }
	•	Response (201): { success:true, jobId, startedAt }
	•	Если уже есть активный джоб: 409 { success:false, code:"ALREADY_RUNNING", jobId }

GET /api/projects/:id/reanalyze/status?jobId=…
	•	Response 200:

{ "success": true,
  "status": "queued|running|succeeded|failed|canceled|timeout",
  "progress": { "percent": 0..100, "step": "hook|structure|emotional|cta|synthesis" },
  "candidateVersionId": "vX" | null,
  "error": null | { "code": "ANTHROPIC_429|GENERIC", "message": "..." }
}



GET /api/projects/:id/reanalyze/compare/latest
	•	Response 200:

{ "success": true,
  "data": {
    "base": {
      "versionId":"vN",
      "overall":79,
      "breakdown": { "hook":78, "structure":88, "emotional":72, "cta":72 },
      "architectReview": "…",
      "scenes":[{"id":1,"text":"…"}, …]
    },
    "candidate": {
      "versionId":"vN+1",
      "overall":83,
      "breakdown": { "hook":84, "structure":90, "emotional":76, "cta":82 },
      "architectReview":"…",
      "scenes":[{"id":1,"text":"…"}, …]
    }
  }
}


	•	Если черновика нет: 404 { success:false, code:"NO_CANDIDATE" }

POST /api/projects/:id/reanalyze/compare/choose
	•	Request: { choice: "base" | "candidate" }
	•	Response 200: { success:true, currentVersionId:"v…" }
	•	Побочные эффекты: пометить candidate применённым/снять флаг isCandidate, инвалидация кэшей.

DELETE /api/projects/:id/reanalyze/candidate
	•	Отмена черновика. Response 200 { success:true }

Технически важно: все ответы строго JSON, никакого HTML при ошибках.

2) Асинхронный джоб
	•	Max TTL одного прогона: 120 сек, с повтором backoff при 429/5xx (например, 3 ретрая, экспоненциальный: 1s, 3s, 7s).
	•	Таймаут фронта (UI): не жёсткий «70 секунд», а пока статус != final. На 2 минуты — показываем прогресс; если вышло время — показываем «Можно подождать ещё / отменить / повторить».
	•	Возвращать шаги для прогресса: hook → structure → emotional → cta → synthesis.

3) UI / копирайтинг (рус.)

Панель статуса (S1):
	•	Заголовок: «Пересчёт сценария»
	•	Саб: «Задача в очереди…» / «Анализируем: Хук / Структура / Эмоции / CTA / Синтез»
	•	Прогресс-бар.
	•	Кнопка: «Отменить черновик».

Кнопки (S0):
	•	«Создать черновик для сравнения»
	•	«Все версии (история)»

Кнопки (S2):
	•	«Открыть сравнение (ДО/ПОСЛЕ)»
	•	«Отменить черновик»

Compare Modal
	•	Две вкладки: «Метрики» и «Сцены».
	•	Метрики: общий балл, 4 зоны (хук/структура/эмоции/CTA), «Рецензия AI-архитектора» для каждой стороны, шильды Δ-дельт.
	•	Сцены: две колонки «До» / «После», подсветка изменённых сцен.
	•	Кнопки: «Оставить ДО» и «Выбрать ПОСЛЕ».
	•	После выбора: тост «Версия сохранена: vN → vN+1», модалка закрывается, кнопка сравнения исчезает.

История
	•	Заголовок модалки: «Все версии (история)»
	•	Описание: «Архив всех сохранённых версий (v1…vN). Просматривайте сцены и восстанавливайте любую версию».
	•	Слева список версий с бейджем AI/ручные, балл; справа — сцены выбранной версии и кнопка «Восстановить».

Тосты
	•	Создание черновика: «Создаём черновик для сравнения…»
	•	Готов: «Черновик готов: откройте сравнение (ДО/ПОСЛЕ)»
	•	Отмена: «Черновик отменён»
	•	Выбор ПОСЛЕ: «Новая версия применена»
	•	Ошибка (429/таймаут): «Пересчёт занял слишком долго. Попробуйте снова или отмените черновик.»

4) Инвалидация кэшей (обязательно)

После любого из действий (start, status->succeeded, choose, cancel) инвалидация:
	•	/api/projects/:id
	•	/api/projects/:id/script-history
	•	/api/projects/:id/scene-recommendations
	•	/api/projects/:id/reanalyze/* (status/compare/latest)

5) QA-чеклист (ручной прогон)
	1.	S0 → S1: нажать «Создать черновик для сравнения» → показать панель статуса, кнопка создания блокируется.
	2.	Статус поллится каждые 2 сек, прогресс двигается по шагам.
	3.	S1 → S2: после succeeded появляется «Открыть сравнение (ДО/ПОСЛЕ)».
	4.	Модалка сравнения: вкладки «Метрики/Сцены», рецензии, дельты, тексты сцен.
	5.	Выбрать ПОСЛЕ: модалка закрылась, тост «Применено», кнопка сравнения пропала, текущая версия обновилась, история пополнилась.
	6.	Отменить черновик (из S1 и S2): черновик помечен isRejected, сравнение скрыто, тост «Отменён».
	7.	Retry при 429/таймауте: прогресс продолжает, либо понятная ошибка + кнопки «Повторить / Отменить».
	8.	Только JSON: все API (в т.ч. ошибки) возвращают JSON — модалка не падает с <!DOCTYPE…>.

⸻

Краткая памятка для тебя (пользователя)
	•	«Создать черновик для сравнения» — запрашивает новый автопересчёт.
	•	Когда готово — жми «Открыть сравнение (ДО/ПОСЛЕ)», выбери вариант.
	•	После выбора сравнение исчезает (потому что черновик “использован”).
	•	Все прошлые версии — в «Все версии (история)»: там можно посмотреть и восстановить любую.

⸻

Почему у тебя «Метрики 0 0 52 0 0» иногда

Для старых версий, созданных до внедрения breakdown, метрики могли не писаться. Обновлённый пересчёт пишет полный breakdown и «рецензию архитектора». Решение: создать новый черновик → сравнение покажет актуальные цифры.

⸻

Хочешь — перешлю это ТЗ реплиту в виде чек-листа задач и acceptance-критериев (как выше). Если что-то из логики ещё хочется подправить (названия, тексты тостов, порядок кнопок) — скажи, внесу сразу.