Вот чёткое ТЗ для реплита на улучшение Stage 8 «Performance Analytics».

Цель
	1.	Вынести подключение Instagram Business/Creator из Stage 8 в настройки пользователя (User Settings).
	2.	Привести в порядок верстку Stage 8: единая сетка, типографика, отступы, адаптив.

⸻

1) Подключение Instagram → в User Settings

Что меняем
	•	Блок «Подключение Instagram» убираем из Stage 8.
	•	Вводим страницу/модал User Settings → Integrations → Instagram.
	•	Stage 8 только читает статус интеграции и связанные аккаунты/страницы/IG-юзера.

Бэкенд (API)

Новые/уточнённые эндпоинты под пользователя (scoped по userId):
	•	GET /api/integrations/ig/accounts
	•	Возвращает список подключённых Instagram-аккаунтов (если у нас разрешён мульти-аккаунт), их статус токена, срок истечения.
	•	POST /api/integrations/ig/auth/url
	•	Возвращает URL Facebook Login с нужными scope.
	•	GET /api/integrations/ig/auth/callback?code=...
	•	После OAuth: сохраняет/обновляет IgAccount (LL token, expiry, fbPage, igUserId). Возвращает {success, igUserId, fbPageId, tokenExpiresAt}.
	•	DELETE /api/integrations/ig/accounts/:id
	•	Отвязать аккаунт, очистить токены, остановить синки.

Backward compatibility: существующие GET /api/ig/accounts можно оставить как алиас на новые маршруты, но Stage 8 должен звать новые.

Фронтенд (UI)

User Settings → Integrations → Instagram

Компоненты:
	•	Карточка «Instagram»
	•	Статус:
	•	Подключен (показывать @handle / Page name / истекает через N дней)
	•	Требуется переавторизация (кнопка «Переавторизовать»)
	•	Не подключён
	•	Кнопки:
	•	Подключить Instagram
	•	Переавторизовать (если exp < 14 дней или auth_error)
	•	Отключить
	•	Хинт-текст с требованиями (Business/Creator + привязка к Page + права).
	•	Тосты:
	•	«Аккаунт подключён», «Переавторизация выполнена», «Аккаунт отключён», «Недостаточно прав: …», «Токен истёк, подключитесь повторно».

Stage 8 (обновлённый)
	•	Блок «Подключение Instagram» заменяем на:
	•	Если не подключено: компактный баннер «Instagram не подключён» + кнопка Открыть настройки (ведёт в User Settings).
	•	Если подключено: показываем handle/Page + бейдж «ОК»/«Истекает через N дней».
	•	Остальной функционал Stage 8 (лента Reels, привязка к версиям, синк, сравнение predicted vs actual) без изменений.

⸻

2) Верстка Stage 8 — правки

Принципы
	•	Сетка: 12-колоночная, контейнер по центру, max-width 1200–1280px.
	•	Отступы: вертикальные секции pt-6 pb-8, внутри секции карточки p-5 (md: p-6).
	•	Шрифты: заголовки секций text-xl font-semibold, сабтайтл text-sm text-muted-foreground.
	•	Card UI: используем один паттерн (shadcn/ui Card), без «зоопарка» отступов.
	•	Иконки/бейджи: единый размер 18px, бейджи text-xs, тон.
	•	Адаптив: ≥ 1024px — две колонки (например: левая — список Reels, правая — привязки/версии); < 1024px — одна колонка, карточки по вертикали.

Конкретные проблемы (со скрина) и как чинить
	•	«Прыгающие» высоты карточек → фиксированные внутренние паддинги, контент лейаут без лишних min-h-*.
	•	Рваные межсекционные расстояния → общий wrapper секции с space-y-6.
	•	Непопадающие выравнивания заголовков/кнопок → использовать flex-контейнер justify-between items-center для хедера каждой секции.
	•	Кнопки разного размера → нормализовать на Button из shadcn/ui, варианты: default|secondary|outline, размеры sm|default.
	•	Дисплей статусов (rate_limited, error) — показывать одинаковыми Badge + короткая подсказка.

Структура секций (рекомендация)
	1.	Header страницы: «Performance Analytics» + сабтайтл.
	2.	Интеграция:
	•	Если не подключено: баннер с CTA «Открыть настройки».
	•	Если подключено: компактная карточка статуса (handle/Page, истечение, кнопка Обновить токен если скоро истекает).
	3.	Reels (лента):
	•	Таблица/лист с превью, датой публикации, статусом синка, последними метриками, кнопка Привязать к версии….
	4.	Привязки версий:
	•	Список v1…vN: predicted vs actual (дельты), бейдж «обновлено X мин назад», Обновить сейчас.
	5.	Рекомендации AI:
	•	3–5 буллетов на основе дельт.
	6.	Логи/ошибки (dev only, if debug):
	•	Свернутый аккордеон с последним syncError (если есть), чтобы QA не ходил в консоль.

⸻

3) Изменения в коде (high-level)

Бэкенд
	•	Вынести логику OAuth/LL-Token в server/modules/integrations/instagram/*.
	•	Актуализировать маршруты на /api/integrations/ig/*.
	•	Перенести миграции/модели IgAccount из project scope → user scope (если ещё не так).
	•	Добавить soft-метку статуса аккаунта: ok | auth_error | expiring.
	•	Вернуть expiringAt и daysLeft в ответах.

Фронтенд
	•	Новая страница/модал UserSettingsIntegrationsInstagram.tsx
	•	useQuery: /api/integrations/ig/accounts
	•	useMutation: auth/url, callback, disconnect
	•	Stage8.tsx
	•	Убрать форму OAuth.
	•	Добавить баннер/карточку статуса + кнопка Открыть настройки.
	•	Остальные запросы/мутaции (лента, биндинги, инсайты, синк) оставить.
	•	Навигация
	•	Кнопка «Настройки» в профиле пользователя.
	•	Из Stage 8 Открыть настройки → роут на User Settings с якорем #integrations-instagram.

⸻

4) Тексты и тосты (готовые)
	•	Настройки/Интеграции/Instagram
	•	Успехи:
	•	Аккаунт Instagram подключён
	•	Переавторизация выполнена
	•	Аккаунт отключён
	•	Ошибки:
	•	Недостаточно прав: {scope}
	•	Требуется бизнес-аккаунт, привязанный к Facebook Page
	•	Токен истёк — подключитесь повторно
	•	Stage 8
	•	Instagram не подключён — откройте настройки, чтобы подключить аккаунт
	•	Токен скоро истекает — переавторизуйте в настройках

⸻

5) Acceptance Criteria
	1.	В User Settings → Integrations вижу карточку Instagram: статус/handle/Page/дата истечения.
	2.	Могу подключить/переавторизовать/отвязать аккаунт из настроек; тосты отображаются.
	3.	На Stage 8:
	•	Если нет интеграции — баннер с CTA «Открыть настройки».
	•	Если есть — показ статуса без возможности OAuth со Stage 8.
	4.	Сетка Stage 8 аккуратная: единые отступы, ровные карточки, кнопки одного стиля. На ширинах 1440/1280/1024/768/375 выглядит корректно.
	5.	Никакой функционал привязок/синков/сравнений не поломан.
	6.	При истекающем токене (<14 дней) вижу предупреждение в карточке статуса и в настройках.
	7.	Lighthouse (desktop) Layout Shift < 0.02, нет скачков интерфейса.

⸻

6) Smoke-тесты (QA)
	•	Подключить валидный бизнес-аккаунт → статус «Подключён».
	•	Попробовать подключить личный аккаунт → корректное сообщение.
	•	На Stage 8 увидеть корректный баннер/карточку статуса, открыть настройки.
	•	Проверить адаптивность (375/768/1024/1440).
	•	Прогнать весь flow с привязкой Reels к версии (чтобы убедиться, что перенос OAuth ничего не сломал).

⸻

7) Что НЕ делаем в этой задаче
	•	Не меняем сам sync-сервис, очереди и расчёт дельт.
	•	Не внедряем вебхуки — только перенос OAuth в настройки и наведение порядка в UI Stage 8.

⸻

Если нужно, могу сразу накидать короткие issues чек-листом (по файлам/компонентам) и предложить референс-скриншот сетки для Stage 8, чтобы верстальщик не гадал про отступы.