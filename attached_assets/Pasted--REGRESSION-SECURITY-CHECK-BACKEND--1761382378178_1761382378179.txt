

üîé REGRESSION & SECURITY CHECK ‚Äî BACKEND

–ó–∞–¥–∞—á–∞: –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤–Ω–µ–¥—Ä—ë–Ω–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ: –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç–µ–π, –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —Å –≤–µ—Ä–Ω—ã–º–∏ scene_id, –Ω–∞–ª–∏—á–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ /script-versions, –∏ SSRF-–∑–∞—â–∏—Ç–∞ –≤ fetchAndExtract.

–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ê–ù–ù–´–ï (–∑–∞–ø–æ–ª–Ω–∏ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º)
	‚Ä¢	PROJECT_ID: <–≤—Å—Ç–∞–≤—å UUID –ø—Ä–æ–µ–∫—Ç–∞>
	‚Ä¢	NEWS_ID: <–≤—Å—Ç–∞–≤—å UUID rss_items>
	‚Ä¢	ANTHROPIC_API_KEY: —É–∂–µ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏

0) –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
	1.	–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä, –æ—á–∏—Å—Ç–∏ –∫–æ–Ω—Å–æ–ª—å.
	2.	–í–∫–ª—é—á–∏ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ä–æ—É—Ç–æ–≤ fetch-full-content –∏ generate-script.

–û–∂–∏–¥–∞–Ω–∏–µ: —Å–µ—Ä–≤–µ—Ä –ø–æ–¥–Ω—è—Ç –±–µ–∑ –æ—à–∏–±–æ–∫.

1) –ü—Ä–æ–≤–µ—Ä–∫–∞ /api/news/:id/fetch-full-content

–í—ã–ø–æ–ª–Ω–∏:

curl -s -X POST http://localhost:5000/api/news/$NEWS_ID/fetch-full-content | jq .

–ü—Ä–æ–≤–µ—Ä—å –∏ –ø—Ä–∏–ª–æ–∂–∏ –≤ —á–∞—Ç:
	‚Ä¢	success: true –∏ content –¥–ª–∏–Ω–æ–π > 1000 —Å–∏–º–≤–æ–ª–æ–≤, cached: true|false.
	‚Ä¢	–ï—Å–ª–∏ success: false, –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–π—Ç–∏ fallback –∏ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–π error (not-html|too-short|readability-failed|extract_failed|timeout –∏ —Ç.–¥.).
	‚Ä¢	–í –ë–î —Ç–∞–±–ª–∏—Ü–µ rss_items —É –∑–∞–ø–∏—Å–∏ $NEWS_ID –ø–æ–ª—è full_content –∏ last_fetched_at –æ–±–Ω–æ–≤–ª–µ–Ω—ã.

2) –ù–∞–ª–∏—á–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ /api/projects/:id/script-versions

–í—ã–ø–æ–ª–Ω–∏:

curl -s http://localhost:5000/api/projects/$PROJECT_ID/script-versions | jq .

–û–∂–∏–¥–∞–Ω–∏–µ: JSON —Å –∫–ª—é—á–æ–º versions (–º–∞—Å—Å–∏–≤). –ü—Ä–∏–ª–æ–∂–∏ –æ—Ç–≤–µ—Ç.

3) –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è + –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

–°–º–æ–¥–µ–ª–∏—Ä—É–π –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∑–∞–ø—Ä–æ—Å –¥–≤–∞–∂–¥—ã —Å –æ–¥–Ω–∏–º X-Idempotency-Key:

IDK=$(uuidgen)
curl -s -X POST \
  -H "Content-Type: application/json" \
  -H "X-Idempotency-Key: $IDK" \
  -d '{"format":"news_update","sourceContent":"–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç (–∏–ª–∏ –≤–æ–∑—å–º–∏ –∏–∑ fullContent)"}' \
  http://localhost:5000/api/projects/$PROJECT_ID/generate-script | jq .

curl -s -X POST \
  -H "Content-Type: application/json" \
  -H "X-Idempotency-Key: $IDK" \
  -d '{"format":"news_update","sourceContent":"–¢–æ—Ç –∂–µ —Ç–µ–∫—Å—Ç"}' \
  http://localhost:5000/api/projects/$PROJECT_ID/generate-script | jq .

–û–∂–∏–¥–∞–Ω–∏–µ:
	‚Ä¢	–ü–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç: { ok: true, versionId: "...", reused: false|absent }.
	‚Ä¢	–í—Ç–æ—Ä–æ–π –æ—Ç–≤–µ—Ç: { ok: true, reused: true, versionId: "—Ç–æ—Ç –∂–µ id" }.
	‚Ä¢	–í –∫–æ–Ω—Å–æ–ª–∏ –≤–∏–¥–Ω—ã –ª–æ–≥–∏: Generate Script ‚Üí created version ... –∏ idempotency reused ....

–ü—Ä–∏–ª–æ–∂–∏ –æ–±–∞ –æ—Ç–≤–µ—Ç–∞ –∏ –ª–æ–≥–∏.

4) –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è script_versions –∏ scene_recommendations

–°–¥–µ–ª–∞–π SQL-–ø—Ä–æ–≤–µ—Ä–∫—É (—á–µ—Ä–µ–∑ psql/GUI) –∏ –ø—Ä–∏–ª–æ–∂–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:

-- –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞
SELECT id, version_number, is_current, analysis_score, provenance
FROM script_versions
WHERE project_id = '$PROJECT_ID'
ORDER BY version_number DESC
LIMIT 3;

-- –°—Ü–µ–Ω—ã —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ (–¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å id 1..N –≤ JSON)
SELECT scenes
FROM script_versions
WHERE project_id = '$PROJECT_ID' AND is_current = true;

-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
SELECT sr.id, sr.script_version_id, sr.scene_id, sr.area, sr.priority, sr.score_delta, sr.applied
FROM scene_recommendations sr
JOIN script_versions sv ON sv.id = sr.script_version_id
WHERE sv.project_id = '$PROJECT_ID' AND sv.is_current = true
ORDER BY sr.scene_id, sr.priority DESC
LIMIT 50;

–û–∂–∏–¥–∞–Ω–∏–µ:
	‚Ä¢	–í scenes —É –∫–∞–∂–¥–æ–π —Å—Ü–µ–Ω—ã –≤ JSON –µ—Å—Ç—å id: 1..N (–ø–æ—Ä—è–¥–∫–æ–≤—ã–µ).
	‚Ä¢	–í scene_recommendations.scene_id —Å—Ç–æ—è—Ç –Ω–µ–Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, —Å–æ–≤–ø–∞–¥–∞—é—â–∏–µ —Å –ø–æ—Ä—è–¥–∫–æ–º —Å—Ü–µ–Ω.
	‚Ä¢	–ï—Å—Ç—å score_delta (–µ—Å–ª–∏ expectedImpact –±—ã–ª —É–∫–∞–∑–∞–Ω), –∏ provenance.idempotencyKey –≤ script_versions.

5) –ü—Ä–æ–≤–µ—Ä–∫–∞ ¬´–ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é¬ª (backend)

–°—ã–º–∏—Ç–∏—Ä—É–π –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–¥–Ω–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

REC_ID="<–ø–æ–¥—Å—Ç–∞–≤—å id –∏–∑ –≤—ã–±–æ—Ä–∫–∏ –≤—ã—à–µ>"
curl -s -X POST \
  -H "Content-Type: application/json" \
  -d "{\"sceneId\":1, \"recommendationId\":\"$REC_ID\"}" \
  http://localhost:5000/api/projects/$PROJECT_ID/apply-scene-recommendation | jq .

–û–∂–∏–¥–∞–Ω–∏–µ:
	‚Ä¢	–û—Ç–≤–µ—Ç { success: true, newVersion: {...}, affectedScene: {...} }.
	‚Ä¢	–í –ë–î:
	‚Ä¢	–ü–æ—è–≤–∏–ª–∞—Å—å –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å is_current = true, version_number —É–≤–µ–ª–∏—á–∏–ª—Å—è –Ω–∞ +1.
	‚Ä¢	–í scene_recommendations —É REC_ID –ø–æ–ª–µ applied = true, applied_at –Ω–µ NULL.

–ü—Ä–∏–ª–æ–∂–∏ –æ—Ç–≤–µ—Ç –∏ SQL-–ø—Ä–æ–≤–µ—Ä–∫—É.

6) SSRF-–∑–∞—â–∏—Ç–∞ –≤ fetchAndExtract

–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –∑–∞—â–∏—â–∞–µ–º—Å—è –æ—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö/¬´–º–∞–≥–∏—á–µ—Å–∫–∏—Ö¬ª –¥–æ–º–µ–Ω–æ–≤ –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤:

# –æ–∂–∏–¥–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É/–æ—à–∏–±–∫—É
curl -s -X POST http://localhost:5000/api/news/$NEWS_ID/fetch-full-content \
  -H 'Content-Type: application/json' \
  -d '{"testUrl":"http://127.0.0.1"}' | jq .

curl -s -X POST http://localhost:5000/api/news/$NEWS_ID/fetch-full-content \
  -H 'Content-Type: application/json' \
  -d '{"testUrl":"http://anything.nip.io"}' | jq .

(–ï—Å–ª–∏ —É —Ç–µ–±—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ testUrl –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π; –µ—Å–ª–∏ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –ø–æ –∫–æ–¥—É/–ª–æ–≥–∞–º, —á—Ç–æ: –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è DNS-—Ä–µ–∑–æ–ª–≤—ã, IPv4 private CIDR, –∑–∞–ø—Ä–µ—â–µ–Ω—ã –¥–æ–º–µ–Ω—ã .nip.io/.xip.io/.sslip.io/.localtest.me, —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è –Ω–∞ –∫–∞–∂–¥–æ–º hop, –ª–∏–º–∏—Ç 5 hops.)

–û–∂–∏–¥–∞–Ω–∏–µ: –æ—Ç–≤–µ—Ç—ã —Å –æ—Ç–∫–∞–∑–æ–º –∏ –ª–æ–≥–∞–º–∏ –≤—Ä–æ–¥–µ Private IPv4 blocked / Blocked host / too-many-redirects.

7) /api/projects/:id/script-history

–ü—Ä–æ–≤–µ—Ä—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å—Ç–∞—Ä–æ–≥–æ UI:

curl -s http://localhost:5000/api/projects/$PROJECT_ID/script-history | jq .

–û–∂–∏–¥–∞–Ω–∏–µ: –≤–∞–ª–∏–¥–Ω—ã–π –æ—Ç–≤–µ—Ç —Å currentVersion, versions, recommendations. –ü—Ä–∏–ª–æ–∂–∏ –æ—Ç–≤–µ—Ç.

‚∏ª

–ò—Ç–æ–≥: –ø—Ä–∏–ª–æ–∂–∏ –≤ —á–∞—Ç
	‚Ä¢	–°—ã—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã –≤—Å–µ—Ö curl (–≤–∫–ª—é—á–∞—è jq .).
	‚Ä¢	SQL-–≤—ã–±–æ—Ä–∫–∏ (–∫–∞–∫ —Ç–µ–∫—Å—Ç).
	‚Ä¢	–ö–ª—é—á–µ–≤—ã–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ —à–∞–≥–∞–º.
	‚Ä¢	–ö—Ä–∞—Ç–∫–∏–π –≤–µ—Ä–¥–∏–∫—Ç –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É (‚úÖ/‚ùå + –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π).

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —É–ø–∞–¥—ë—Ç:
	‚Ä¢	–¥–∞–π —Ç–æ—á–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏,
	‚Ä¢	—É–∫–∞–∂–∏, –Ω–∞ –∫–∞–∫–æ–º —à–∞–≥–µ,
	‚Ä¢	–ø—Ä–∏–ª–æ–∂–∏ –∫—É—Å–æ–∫ –ª–æ–≥–æ–≤,
	‚Ä¢	–∏ —Å—Ä–∞–∑—É –ø—Ä–µ–¥–ª–æ–∂–∏ —Ñ–∏–∫—Å (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ-–∏–Ω–≤–∞–∑–∏–≤–Ω—ã–π).

‚∏ª
