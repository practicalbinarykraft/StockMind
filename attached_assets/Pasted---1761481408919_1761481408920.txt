–ö–æ—Ä–æ—Ç–∫–æ: –æ—Å—Ç–∞–≤–ª—è–µ–º –º–æ–¥–µ–ª—å ‚Äú–∫–∞–Ω–¥–∏–¥–∞—Ç ‚Üí —Å—Ä–∞–≤–Ω–∏—Ç—å ‚Üí –ø—Ä–∏–Ω—è—Ç—å‚Äù. –≠—Ç–æ –ª—É—á—à–µ, —á–µ–º —Å—Ä–∞–∑—É –¥–µ–ª–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é —Ç–µ–∫—É—â–µ–π.

–ü–æ—á–µ–º—É —Ç–∞–∫

–ü–ª—é—Å—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):
	‚Ä¢	üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ: —Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –æ—Å—Ç–∞—ë—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π, –Ω–µ –ª–æ–º–∞–µ–º Stage 4+.
	‚Ä¢	üëÄ –ü—Ä–æ–∑—Ä–∞—á–Ω–æ: –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å ¬´–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π¬ª, —É–≤–∏–¥–µ—Ç—å –¥–µ–ª—å—Ç—É –ø–æ –±–∞–ª–ª–∞–º –∏ —Ç–µ–∫—Å—Ç–∞–º, –∞ –ø–æ—Ç–æ–º —Ä–µ—à–∏—Ç—å ‚Äî –ø—Ä–∏–Ω—è—Ç—å –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–∞–≤–∫–∞–º.
	‚Ä¢	üîÑ –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ: –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –≤–∞—à –∂–µ–ª–∞–µ–º—ã–π UX (‚Äú–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é‚Äù ‚Üí –∞–≤—Ç–æ—Ä–µ–∞–Ω–∞–ª–∏–∑ ‚Üí ¬´–°—Ä–∞–≤–Ω–∏—Ç—å¬ª ‚Üí ¬´–ü—Ä–∏–Ω—è—Ç—å –Ω–æ–≤—É—é¬ª/¬´–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é¬ª/¬´–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–∑–≤—É—á–∫–µ¬ª).

–ú–∏–Ω—É—Å—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: —á—É—Ç—å –±–æ–ª—å—à–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π, –Ω–æ —ç—Ç–æ –ª–µ—á–∏—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º UI –∏ –∫–µ—à-–∏–Ω–≤–∞–ª–∏–¥–∏–∞—Ü–∏–µ–π (–Ω–∏–∂–µ).

–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (—Å—Ä–∞–∑—É –¥–µ–ª–∞—Ç—å —Ç–µ–∫—É—â–µ–π):
	‚Ä¢	‚úÖ –ü—Ä–æ—â–µ –º–µ–Ω—Ç–∞–ª—å–Ω–æ, –Ω–æ
	‚Ä¢	‚ö†Ô∏è –†–∏—Å–∫: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ¬´–ª–æ–º–∞–µ–º¬ª –±–∞–∑–æ–≤—É—é –≤–µ—Ä—Å–∏—é; —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ ¬´vN-1 vs vN¬ª, –∞ –æ—Ç–∫–∞—Ç ‚Äî —Å–ª–æ–∂–Ω–µ–µ.

‚∏ª

–ß—Ç–æ –¥–µ–ª–∞–µ–º, —á—Ç–æ–±—ã –∫–∞–Ω–¥–∏–¥–∞—Ç —Ä–∞–±–æ—Ç–∞–ª –±–µ–∑ –±–æ–ª–∏

1) Backend ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞, –Ω–æ –¥–æ–ø–∏–ª–∏—Ç—å —Ñ–ª–æ—É
	‚Ä¢	POST /api/projects/:id/versions ‚Äî —Å–æ–∑–¥–∞—ë—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ (is_candidate=true, is_current=false), —Å—Ä–∞–∑—É —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç –∞–Ω–∞–ª–∏–∑, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
	‚Ä¢	currentVersion, candidateVersion, versions (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ).
	‚Ä¢	PUT /api/projects/:id/versions/:versionId/accept ‚Äî –¥–µ–ª–∞–µ—Ç –ø—Ä–∏–Ω—è—Ç–∏–µ:
	‚Ä¢	–≤—Å–µ–º –≤–µ—Ä—Å–∏—è–º is_current=false, —É –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ is_current=true, is_candidate=false.
	‚Ä¢	–Ω–∏—á–µ–≥–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ (–º–µ—Ç—Ä–∏–∫–∏ —É–∂–µ –µ—Å—Ç—å).
	‚Ä¢	DELETE /api/projects/:id/versions/:versionId ‚Äî –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ (–ø–æ –∂–µ–ª–∞–Ω–∏—é).

–¢—ã —É–∂–µ –Ω–∞—à—ë–ª –∏ –ø–æ—Ñ–∏–∫—Å–∏–ª —Ñ–æ—Ä–º—É–ª—ã –æ—á–∫–æ–≤. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–¥–∫–ª—é—á–∏ –º–æ–π –º–∞–ø–ø–µ—Ä (–∏–ª–∏ –∞–Ω–∞–ª–æ–≥) –≤–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö, –≥–¥–µ —Å–æ–±–∏—Ä–∞–µ—à—å metrics, —á—Ç–æ–±—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ –Ω–µ –Ω—É–ª–∏.

2) Frontend ‚Äî —Ä–µ–Ω–¥–µ—Ä–∏–º —Ç–æ, —á—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª–∏

–í —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ —Å—Ü–µ–Ω –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å (—ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è, –∫–æ—Ç–æ—Ä—É—é —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏), –∏–Ω–∞—á–µ —Ç–µ–∫—É—â—É—é:

// scene-editor.tsx
const current = data?.versions?.find(v => v.is_current)
const candidate = data?.versions?.find(v => v.is_candidate)
const versionToRender = candidate ?? current

–î–æ–±–∞–≤–ª—è–µ–º –±–∞–Ω–Ω–µ—Ä –Ω–∞–¥ —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º:
	‚Ä¢	¬´–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è vN+1 —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ ‚Ä¢ –ê–Ω–∞–ª–∏–∑: [–∏–¥—ë—Ç]/[–≥–æ—Ç–æ–≤]¬ª
	‚Ä¢	–ö–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∞: [–°—Ä–∞–≤–Ω–∏—Ç—å] [–ü—Ä–∏–Ω—è—Ç—å –Ω–æ–≤—É—é] [–û—Ç–º–µ–Ω–∏—Ç—å]

3) –ö–µ—à-–∏–Ω–≤–∞–ª–∏–¥–∏–∞—Ü–∏—è (–≥–ª–∞–≤–Ω–æ–µ –º–µ—Å—Ç–æ, –≥–¥–µ –≤—Å—ë –ª–æ–º–∞–ª–æ—Å—å)

–°—Ä–∞–∑—É –ø–æ—Å–ª–µ:
	‚Ä¢	save new version (—Å–æ–∑–¥–∞–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞),
	‚Ä¢	apply recommendation(s),
	‚Ä¢	run analysis (–±—ã—Å—Ç—Ä—ã–π –∞–Ω–∞–ª–∏–∑),
	‚Ä¢	accept candidate/reject,

–¥–µ–ª–∞–µ–º –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—é –∫–ª—é—á–µ–π –∏/–∏–ª–∏ –ø—Ä—è–º–æ–π setQueryData:

import { queryClient } from "@/lib/query"

function invalidateProject(id: string) {
  queryClient.invalidateQueries({ queryKey: ["/api/projects", id] })
  queryClient.invalidateQueries({ queryKey: ["/api/projects", id, "versions"] })
  queryClient.invalidateQueries({ queryKey: ["/api/projects", id, "script-history"] })
}

// onSuccess:
invalidateProject(projectId)
// –∏/–∏–ª–∏ –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ:
queryClient.setQueryData(["/api/projects", projectId, "versions"], data.versions)

–ü–ª—é—Å, –µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞, –∞–∫—Ç–∏–≤–∏—Ä—É–π ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é¬ª –ø—Ä–∏ –ª—é–±—ã—Ö —Ä–∞–∑–ª–∏—á–∏—è—Ö –º–µ–∂–¥—É —Ç–µ–∫—Å—Ç–æ–º —Ñ–æ—Ä–º—ã –∏ versionToRender.scenes.

4) –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π
	‚Ä¢	–ò—Å—Ç–æ—á–Ω–∏–∫ ¬´–î–æ¬ª ‚Äî current.
	‚Ä¢	–ò—Å—Ç–æ—á–Ω–∏–∫ ¬´–ü–æ—Å–ª–µ¬ª ‚Äî candidate.
	‚Ä¢	–ú–µ—Ç—Ä–∏–∫–∏ –±–µ—Ä—ë–º –∏–∑ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö metrics (–ø–æ—Å–ª–µ —Ç–≤–æ–µ–≥–æ —Ñ–∏–∫—Å–∞ —Ñ–æ—Ä–º—É–ª).
	‚Ä¢	–ö–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É: [–û—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é] [–ü—Ä–∏–Ω—è—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é] [–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–∑–≤—É—á–∫–µ].

‚∏ª

TL;DR ‚Äî –≥–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ
	‚Ä¢	–û—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç –∫–∞–∫ –Ω–æ–≤—É—é —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é.
	‚Ä¢	–í —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å.
	‚Ä¢	–ü–æ—Å–ª–µ –ª—é–±–æ–π –º—É—Ç–∞—Ü–∏–∏ ‚Äî –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–µ—à (–∏ –ª—É—á—à–µ —Å—Ä–∞–∑—É –ø—Ä–æ—Å—Ç–∞–≤–ª—è—Ç—å setQueryData).
	‚Ä¢	–ú–µ—Ç—Ä–∏–∫–∏ —Å—á–∏—Ç–∞–µ–º —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –º–∞–ø–ø–µ—Ä (—á—Ç–æ–± –Ω–∏–≥–¥–µ –Ω–µ –±—ã–ª–∏ –Ω—É–ª–∏).
	‚Ä¢	–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç real ¬´–î–æ/–ü–æ—Å–ª–µ¬ª –∏ –¥–∞—ë—Ç ¬´–ü—Ä–∏–Ω—è—Ç—å –Ω–æ–≤—É—é¬ª.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —Å–∫–∏–Ω—É –¥–∏—Ñ—Ñ—ã –ø–æ —Ñ–∞–π–ª–∞–º (–º–∞—Ä—à—Ä—É—Ç—ã –±–µ–∫–µ–Ω–¥–∞, –≤—ã–±–æ—Ä –≤–µ—Ä—Å–∏–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ, –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–∞ –∏ –±–∞–Ω–Ω–µ—Ä), —á—Ç–æ–±—ã –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤–∏—Ç—å –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞.