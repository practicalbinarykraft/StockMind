согласен, давай бережно. Ничего не ломаем, количество шагов НЕ меняем. Вся «магия» живёт на одном экране — Stage 3: «Анализ и сценарий». Ни роутов, ни стейт-машины не трогаем. Вот план точечных улучшений, которые добавляют нужный UX без переезда архитектуры.

Цель

Сделать Stage 3 самодостаточным: сверху краткий обзор источника и его анализ, затем рекомендация формата, ниже — сценарий v1 + рекомендации + история. Всё на одной странице.

Что меняем (минимально-рисково)

UI (только внутри Stage 3)
	1.	Source Summary Bar (узкая плашка сверху)

	•	Pills: «Источник: Новость», «Score: 85», «Язык: RU», «Объём: 1 200 слов».
	•	Кнопка «Показать статью» → модал с полным текстом/превью.
	•	Это чисто фронт: берём данные из уже сохранённого project.config/source или analysis.sourceMeta. Никаких новых шагов.

	2.	Блок «Анализ исходника»

	•	Карточка с темами/тональностью/ключевыми словами/рисками.
	•	Эти поля уже у нас есть из анализа; если чего-то нет — показываем только доступное, без ошибок.

	3.	«Рекомендованный формат» (внутри Stage 3)

	•	Маленький бокс с 1–2 рекомендациями + «Почему» + ожидаемый эффект.
	•	Кнопки:
	•	«Применить рекомендованный формат» → вызывает текущий генератор сценария (как сейчас), только добавляет formatId.
	•	«Выбрать другой формат» → открывает прежнюю сетку форматов в модале (не переносим её на первый экран).

	4.	«Сценарий v1 + Рекомендации»

	•	Ниже остаётся твой редактор сцен (уже есть): «Применить / Применить все / История / Пересчитать».
	•	Ничего не меняем в логике версионирования — только визуальные улучшения, которые уже добавляли (badges sourceAgent/scoreDelta/confidence).

Backend (без ломки)
	•	Ничего не рефакторим. Если Stage 3 не получает каких-то крошек данных (например, source.wordCount), подставляем на фронте заглушку «—».
	•	Если очень нужно добрать рекомендацию формата: расширяем ответ текущего «анализ» эндпоинта на Stage 3, добавляя поля recommendedFormats (nullable). Это необязательные поля → не ломают старых клиентов.

Фича-флаг и откат
	•	Заворачиваем новый UI в флаг STAGE3_MAGIC_UI (env или runtime).
	•	По умолчанию включим только на dev/staging. Откат — одна переменная, без отката схем/миграций.

Что именно сделать Replit (чек-лист)

FE (Stage 3)
	•	Добавить SourceSummaryBar (плашка сверху).
	•	Добавить SourcePreviewModal (полный текст).
	•	Добавить секцию SourceAnalysisCard (темы/тон/keywords/risks) — берём из уже приходящего анализа.
	•	Добавить бокс RecommendedFormatBox:
- Если есть рекомендуемый формат → показываем; иначе прячем бокс.
- Кнопки: «Применить рекомендованный» (вызывает существующий генератор сценария с formatId), «Выбрать другой формат» (открывает текущую сетку в модале).
	•	Оставить ниже существующий SceneEditor + History без изменений.
	•	Обернуть всё в фича-флаг STAGE3_MAGIC_UI.

BE (опционально, но без риска)
	•	В ответе анализа исходника (который и так дергается перед генерацией сценария) добавить необязательное поле:

{
  "recommendedFormats": [
    { "id": "news_update", "name": "News Update", "reason": "Высокая новостная ценность", "expectedImpact": { "retention": "+12%", "saves": "+18%" } }
  ]
}

Если это сложно сейчас — фронт просто не покажет бокс.

Контракты (используем текущие)
	•	Генерация сценария: используем твоё существующее «generate script» и просто передаём formatId (если пользователь кликнул «Применить рекомендованный» или выбрал в модале другой).
	•	Анализ сценария: остаётся как есть (multi-agent, рекомендации, версия v1).

Почему это безопасно
	•	Шаги навигации не меняем: слева как было «AI Analysis (3)».
	•	Сервисные эндпоинты не трогаем (опциональный JSON-бонус не ломает никого).
	•	Нет миграций БД.
	•	Весь новый функционал — фронтовые секции под флагом. Откат — 1 переменная.

Acceptance Criteria
	•	Создал проект (источник — новость) → Stage 3 открывается.
	•	Вверху вижу плашку источника и могу открыть статью.
	•	Вижу анализ исходника и (если есть) рекомендованный формат с объяснением.
	•	Нажал «Применить рекомендованный» → сценарий v1 сгенерен, ниже виден редактор.
	•	Могу применить рекомендации, пересчитать и пользоваться историей — всё как сейчас.
	•	Выбрал «Выбрать другой формат» → сетка форматов в модале, после выбора генерится сценарий v1.

План выката
	1.	Реализация под флагом → dev.
	2.	Смоук-тест: новость со Score 85, глазом проверяем плашку/модал/блоки.
	3.	Если ок — включаем флаг на прод.
	4.	Если что-то не так — выключаем флаг, UI вернётся к текущему.

Если хочешь, накину точные JSX-вставки для твоего stage-3 файла (компоненты и пропсы) — скажи стек (у тебя сейчас shadcn/ui + react-query), я дам готовые куски без лишних импортов.