понял. сейчас у тебя «чёрный ящик»: нажал — и тишина. Давай дадим реплиту чёткое ТЗ, чтобы и бэкенд, и фронт вели пользователя за руку: статус, запрет двойных кликов, прогресс, автоповторы, понятные ошибки, «готово — открывай сравнение».

ТЗ: Прозрачный пересчёт + понятный прогресс

1) Бэкенд (обязательные правки)
	1.	POST /api/projects/:id/reanalyze/start
	•	Отдавать 202 сразу с jobId.
	•	Если в проекте уже есть активная задача → 409 + { status:"running", jobId, retryAfter:5 }.
	•	Принимать Idempotency-Key (строка). Если пришёл прежний ключ — вернуть тот же jobId.
	2.	GET /api/projects/:id/reanalyze/status?jobId=…
	•	Возвращать одно из:
	•	{status:"queued"|"running", step:"hook|structure|emotional|cta|synthesis|saving", progress:0-100}
	•	{status:"done", candidateVersionId:"…" }
	•	{status:"error", error:"…", canRetry:true|false }
	•	Таймаут джобы: 70с. На таймаут → status:"error", error:"Reanalysis timed out", canRetry:true.
	•	В job-логах писать: projectId, baseVersionId, scenesCount, длительность этапов, stack trace.
	3.	Хранить прогресс в памяти/БД, чтобы статус был мгновенный.
Обновлять step при каждом агенте: hook → structure → emotional → cta → synthesis → saving.
	4.	Гарантии версии
	•	Candidate создаётся как is_candidate=true, is_current=false.
	•	Точно проставлять sceneNumber = индекс+1 во всех сценах.

2) Фронтенд (UI/UX и поведение)
	1.	Кнопку переименовать: «Сделать версию для сравнения».
Поведение при клике:
	•	Немедленный тост: «Запустили анализ. Это займет до ~1 мин».
	•	Кнопка становится loading + disabled, текст «Идёт анализ…».
	•	Сгенерировать и передать Idempotency-Key (projectId + timestamp/uuid).
	2.	Поллинг статуса
	•	Каждые 2с дергать /reanalyze/status?jobId=…, максимум 70с.
	•	В панели «Инструменты» показать карточку прогресса:
	•	Заголовок: «Пересчет сценария»
	•	Строка статуса: «Шаг: Hook / Structure / Emotional / CTA / Синтез / Сохранение»
	•	Прогресс-бар (0–100)
	•	Текст под прогрессом: «Не закрывайте страницу — мы сохраним результат автоматически».
	3.	Финал/ошибка
	•	По status:"done":
	•	Тост: «Версия для сравнения готова».
	•	Показать кнопку «Открыть сравнение (ДО/ПОСЛЕ)».
	•	Снять loading с «Сделать версию…» (разрешить повторный запуск).
	•	По status:"error":
	•	Красный тост: текст из error.
	•	В карточке прогресса показать описание + кнопку «Попробовать снова» — вызывает reanalyze/start с новым ключом.
	•	Снять loading с «Сделать версию…».
	4.	Защита от двойных кликов
	•	Если start вернул 409 → тост: «Анализ уже идёт», запустить поллинг текущего jobId, кнопку оставить в loading.
	5.	Кнопка «Открыть сравнение (ДО/ПОСЛЕ)»
	•	Открывает модалку (у вас уже есть), данные — из GET /compare/latest.
	•	Кнопки в модалке:
	•	«Оставить ДО» → /compare/choose {keep:"base"}
	•	«Выбрать ПОСЛЕ» → /compare/choose {keep:"candidate"}
	•	После выбора: закрыть модалку, инвалидация script-history, сцены обновить.
	6.	Микротексты (рус)
	•	Старт: «Запустили анализ. Это займет до ~1 мин».
	•	Идет: «Идёт анализ… Шаг: {{step}}».
	•	Готово: «Версия для сравнения готова».
	•	В очереди: «Задача в очереди…».
	•	Таймаут: «Не удалось завершить за 70 секунд. Попробуйте снова».

3) Быстрые фиксы прямо сейчас (чтобы у меня не зависало)
	•	Везде убрать вызовы несуществующих методов (типа storage.getScriptHistory) — заменить на getCurrentScriptVersion/listScriptVersions.
	•	На клиенте обязательно:
	•	блокировать кнопку «Сделать версию…» пока статус queued|running;
	•	показывать карточку прогресса в правой колонке сразу после старта;
	•	тосты по start/409/done/error;
	•	автосброс loading при done|error.
	•	Если job уже шла и я обновил страницу: при монтировании сцены проверять localStorage.reanalyzeJobId и, если есть, автоматически запускать поллинг.

4) Проверка (acceptance)
	1.	Нажал «Сделать версию…»: мгновенный тост + лоадер + карточка прогресса → через ≤70с вижу «готово» и кнопку «Открыть сравнение».
	2.	Если нажал ещё раз во время работы: вижу тост «уже идёт», лоадер не исчезает, прогресс бежит.
	3.	По таймауту: красный тост + кнопка «Попробовать снова».
	4.	«Открыть сравнение»: модалка с ДО/ПОСЛЕ, дельтами по сценам и общим баллом.
	5.	«Выбрать ПОСЛЕ»: текущая версия подменяется, редактор показывает обновлённые сцены.
	6.	Перезагрузил страницу во время работы: карточка прогресса восстанавливается и продолжает поллинг (через сохранённый jobId).

⸻

Если коротко: мне нужны явные статусы, лоадер на кнопке, прогресс-бар в панели, тосты по ключевым событиям, защита от двойных кликов и автоматическое возобновление поллинга. Сейчас самое важное — включить показ карточки прогресса и поллинг сразу после start, чтобы у пользователя не было ощущения «всё зависло».