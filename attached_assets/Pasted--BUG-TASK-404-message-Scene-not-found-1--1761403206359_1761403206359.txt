

üî¥ BUG/TASK: 404 {"message":"Scene not found"} –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –æ–¥–∏–Ω–æ—á–Ω–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1) –°–∏–º–ø—Ç–æ–º—ã
	‚Ä¢	–î–µ–π—Å—Ç–≤–∏–µ: –≤ Scene Editor –Ω–∞–∂–∏–º–∞—é ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é¬ª —É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ü–µ–Ω—ã.
	‚Ä¢	–ó–∞–ø—Ä–æ—Å: POST /api/projects/:projectId/apply-scene-recommendation —Å {"recommendationId": <number>}.
	‚Ä¢	–§–∞–∫—Ç: —Ñ—Ä–æ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç 404 —Å –±–æ–¥–∏ {"message":"Scene not found"}.
	‚Ä¢	Stack (–∫–ª–∏–µ–Ω—Ç): client/src/lib/query-client.ts:6 throwIfResNotOk.

2) –ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å
	‚Ä¢	–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è (is_current = true).
	‚Ä¢	–°–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º —Ü–µ–ª–µ–≤–æ–π —Å—Ü–µ–Ω—ã.
	‚Ä¢	–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ–º–µ—á–∞–µ—Ç—Å—è applied_at = now(), —Ñ—Ä–æ–Ω—Ç—É –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è:

{
  "success": true,
  "data": {
    "appliedCount": 1,
    "affectedScene": { "sceneNumber": <int>, "text": "<updated>" },
    "needsReanalysis": true
  }
}



3) –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–∞—è –ø—Ä–∏—á–∏–Ω–∞ (–∫–æ—Ä–µ–Ω—å)

–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ —Å—Ü–µ–Ω—ã:
	‚Ä¢	–ü—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º scene_number (1..N) –∏/–∏–ª–∏ –æ—à–∏–±–æ—á–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º scene_id –∫–∞–∫ –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä, –∞ —Ä–æ—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—â–µ—Ç —Å—Ü–µ–Ω—É –ø–æ DB ID (–∏–∑ —Ç–∞–±–ª–∏—Ü—ã —Å—Ü–µ–Ω), –ª–∏–±–æ –∏—â–µ—Ç —Å—Ü–µ–Ω—É –≤ –Ω–µ–≤–µ—Ä–Ω–æ–π –≤–µ—Ä—Å–∏–∏ (is_current=false).
	‚Ä¢	–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ —Å—Ü–µ–Ω—ã –ø–æ–ª—É—á–∞—é—Ç –Ω–æ–≤—ã–µ DB ID, –ø–æ—ç—Ç–æ–º—É –ø–æ–∏—Å–∫ –ø–æ —Å—Ç–∞—Ä–æ–º—É scene_id –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç —Å—Ü–µ–Ω—É ‚Üí 404.

4) –¢—Ä–µ–±—É–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (—Å–µ—Ä–≤–µ—Ä)

4.1 –°—Ö–µ–º–∞/–¥–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
	‚Ä¢	–í —Ç–∞–±–ª–∏—Ü–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±–∞ –ø–æ–ª—è:
	‚Ä¢	script_version_id (FK ‚Üí —Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏),
	‚Ä¢	scene_number (int, 1..N –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ),
	‚Ä¢	(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) scene_db_id (FK) ‚Äî –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –¥–ª—è –¥–µ–±–∞–≥–∞, –Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å –ø–æ scene_number.
	‚Ä¢	–ú–∏–≥—Ä–∞—Ü–∏—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ): backfill scene_number –∏–∑ —Ç–µ–∫—Å—Ç–∞/–ø–æ–∑–∏—Ü–∏–∏; –¥–∞–ª—å—à–µ –ø–∏—Å–∞—Ç—å –≤—Å–µ–≥–¥–∞.

4.2 –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é applySceneRecommendation(projectId, recommendationId) –≤ –¢–†–ê–ù–ó–ê–ö–¶–ò–ò:
	1.	–ù–∞–π—Ç–∏ currentVersion = versions.where(project_id = $projectId AND is_current = true); FOR UPDATE.
	2.	–ù–∞–π—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é rec:
	‚Ä¢	rec.script_version_id –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å currentVersion.id.
–ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –≤–µ—Ä–Ω—É—Ç—å 409 VERSION_MISMATCH —Å —Ç–µ–∫—Å—Ç–æ–º:
"Recommendation belongs to different version; re-analyze required".
	3.	–ò–∑–≤–ª–µ—á—å sceneNumber = rec.scene_number.
–ù–∞–π—Ç–∏ —Ü–µ–ª–µ–≤—É—é —Å—Ü–µ–Ω—É –≤ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏: scenes.where(version_id = currentVersion.id AND number = sceneNumber).
	‚Ä¢	–ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî –≤–µ—Ä–Ω—É—Ç—å 404_SCENE_NOT_FOUND_IN_VERSION (–Ω–µ –æ–±—â–∏–π Scene not found).
	4.	–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–π:
	‚Ä¢	–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å—Ü–µ–Ω—ã,
	‚Ä¢	–í —Å—Ü–µ–Ω–µ ‚ÑñsceneNumber –∑–∞–º–µ–Ω–∏—Ç—å text = rec.suggested_text,
	‚Ä¢	–ù–æ–≤—É—é –≤–µ—Ä—Å–∏—é –æ—Ç–º–µ—Ç–∏—Ç—å is_current = true, —Å—Ç–∞—Ä—É—é ‚Äî false.
	5.	–ü–æ–º–µ—Ç–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é applied_at = now(). (–ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ applied_in_version_id = newVersion.id –¥–ª—è –∞—É–¥–∏—Ç–∞.)
	6.	–í–µ—Ä–Ω—É—Ç—å:

{ 
  "success": true,
  "data": {
    "appliedCount": 1,
    "affectedScene": { "sceneNumber": sceneNumber, "text": "<updated>" },
    "needsReanalysis": true
  }
}



4.3 –ö–æ–Ω—Ç—Ä–∞–∫—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞

POST /api/projects/:id/apply-scene-recommendation
	‚Ä¢	–í—Ö–æ–¥: {"recommendationId": number} (–±–µ–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å sceneId —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã —Ñ—Ä–æ–Ω—Ç–∞).
	‚Ä¢	–í—ã—Ö–æ–¥ (200): —Å–º. –ø.2.
	‚Ä¢	–ö–æ–¥—ã –æ—à–∏–±–æ–∫:
	‚Ä¢	404_REC_NOT_FOUND ‚Äî –Ω–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏,
	‚Ä¢	404_SCENE_NOT_FOUND_IN_VERSION ‚Äî –≤ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω scene_number,
	‚Ä¢	409_VERSION_MISMATCH ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –æ—Ç –¥—Ä—É–≥–æ–π –≤–µ—Ä—Å–∏–∏,
	‚Ä¢	500 ‚Äî –ø—Ä–æ—á–∏–µ.

4.4 –õ–æ–≥–∏

–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏:
	‚Ä¢	[ApplyRec] project=<id> rec=<id> version=<id> sceneNumber=<n> ‚Üí newVersion=<id>
	‚Ä¢	–û—Ç–¥–µ–ª—å–Ω—ã–π –ª–æ–≥ –¥–ª—è –æ—à–∏–±–æ–∫ —Å –ø—Ä–∏—á–∏–Ω–∞–º–∏.

5) –ë—ã—Å—Ç—Ä—ã–π –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ç—á (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –¥–æ —Ñ–∏–∫—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞)
	‚Ä¢	–í GET /api/projects/:id/scene-recommendations –≤–µ—Ä–Ω—É—Ç—å –æ–±–∞ –ø–æ–ª—è –≤ –∫–∞–∂–¥–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ:

{
  "id": 123,
  "sceneNumber": 2,
  "sceneDbId": 987,     // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
  ...
}


	‚Ä¢	–§—Ä–æ–Ω—Ç —Å–µ–π—á–∞—Å —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç r.sceneId === sceneNumber. –û–±–Ω–æ–≤–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–æ–≤—ã–π –º–∞–ø–ø–∏–Ω–≥ –Ω–∞ sceneNumber, –∞ –Ω–µ –Ω–∞ sceneId, –ª–∏–±–æ –≤ –æ—Ç–≤–µ—Ç–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø–æ–ª–µ –≤ sceneId = sceneNumber –¥–æ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —Ñ–∏–∫—Å–∞. (–ù–æ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–µ–µ –ø–æ—á–∏–Ω–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –∏ –Ω–µ –ø–ª–æ–¥–∏—Ç—å –ø—É—Ç–∞–Ω–∏—Ü—É.)

6) –ö–∞–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π)
	1.	–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç ‚Üí –ê–Ω–∞–ª–∏–∑ ‚Üí –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π (–ø–æ–ª—É—á–∏—Ç—å 3‚Äì5 —Å—Ü–µ–Ω).
	2.	–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ GET /scene-recommendations –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å –≤–∞–ª–∏–¥–Ω—ã–º–∏ scene_number.
	3.	–ù–∞–∂–∞—Ç—å ¬´–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é¬ª –≤ UI.
–°–µ–π—á–∞—Å: 404 Scene not found.
–ü–æ—Å–ª–µ —Ñ–∏–∫—Å–∞: 200 —Å affectedScene, UI –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç —Å—Ü–µ–Ω—ã –∏ –±–µ–π–¥–∂–∏.

7) –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ curl (–ø–æ—Å–ª–µ —Ñ–∏–∫—Å–∞)

# 1) –°–ø–∏—Å–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
curl -s http://localhost:5000/api/projects/$PID/scene-recommendations | jq

# –í–æ–∑—å–º–∏—Ç–µ –ª—é–±–æ–π recommendationId –∏–∑ –æ—Ç–≤–µ—Ç–∞

# 2) –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–¥–Ω–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
curl -s -X POST http://localhost:5000/api/projects/$PID/apply-scene-recommendation \
  -H 'Content-Type: application/json' \
  -d '{"recommendationId": RECOMMENDATION_ID}' | jq
# –û–∂–∏–¥–∞–Ω–∏–µ: success=true, affectedScene.sceneNumber=X, text="<updated>"

# 3) –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –∏ —Å—Ü–µ–Ω—ã
curl -s http://localhost:5000/api/projects/$PID/script-history | jq '.currentVersion.scenes'

8) SQL –¥–ª—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ (–∫–æ–Ω—Å–æ–ª—å –ë–î)

-- –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è
SELECT id FROM script_versions WHERE project_id = :projectId AND is_current = true;

-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
SELECT id, script_version_id, scene_number, applied_at
FROM scene_recommendations
WHERE script_version_id = :currentVersionId
ORDER BY scene_number;

-- –°—Ü–µ–Ω—ã —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
SELECT number, id, LEFT(text, 60)
FROM script_scenes
WHERE script_version_id = :currentVersionId
ORDER BY number;

9) –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
	‚Ä¢	–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–¥–∏–Ω–æ—á–Ω–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200 –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ü–µ–Ω—É.
	‚Ä¢	–°–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è (is_current=true), —Å—Ç–∞—Ä–∞—è –ø–æ–º–µ—á–∞–µ—Ç—Å—è false.
	‚Ä¢	–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ–ª—É—á–∞–µ—Ç applied_at.
	‚Ä¢	–û—à–∏–±–∫–∏ —Ä–∞–∑–ª–∏—á–∏–º—ã: 404_REC_NOT_FOUND / 404_SCENE_NOT_FOUND_IN_VERSION / 409_VERSION_MISMATCH.
	‚Ä¢	UI —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å—Ü–µ–Ω—ã –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—á—ë—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.

‚∏ª
