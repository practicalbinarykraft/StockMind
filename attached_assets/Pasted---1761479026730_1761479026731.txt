вижу, что «Сравнение версий» у тебя открывается, тексты справа/слева отличаются, а вот метрики/рецензия для «ПОСЛЕ» нули. это типичный рассинхрон: версии уже сохранили, а модалка тянет анализ не той версии или раньше, чем анализ успел сохраниться.

ниже — чёткий разбор, что именно сломано и как это починить без переписывания всего.

Что именно не так
	1.	Метрики «ПОСЛЕ» всегда 0
В модалке берётся currentAnalysis проекта (или compare/latest), а не analysis, привязанный к newVersionId. В итоге для «ПОСЛЕ» приходит пустота/undefined → нули.
	2.	Рецензия «ПОСЛЕ» пустая
По той же причине: рецензия хранится на уровне analysis конкретной версии, а UI смотрит не туда.
	3.	Иногда сцены «ДО/ПОСЛЕ» совпадают
Сохранение новой версии вызывается раньше, чем все выбранные рекомендации действительно применены и зафиксированы в БД → в версию попадает старый текст.
	4.	Кнопка «Сравнение…» активна до того, как закончился ре-анализ
Открыть можно, но новые метрики ещё не готовы → видишь 0/0/0 и «Рецензия недоступна».

Мини-фикс по слоям (коротко и по делу)

Бэкенд

A. Добавь точечный эндпоинт сравнения по versionId
	•	GET /api/projects/:id/compare?baseVersionId=...&targetVersionId=...
	•	Возвращай строго:
	•	baseVersion (id, scenes[], metrics, breakdown, review)
	•	targetVersion (id, scenes[], metrics, breakdown, review, status: queued|running|done|error)
	•	Никаких “latest” и догадок — только по двум явным версиям.

B. После “Сохранить новую версию” сразу ставь задачу анализа этой версии
	•	POST /api/projects/:id/versions → в ответе верни newVersionId
	•	тут же POST /api/projects/:id/analysis/run?versionId=newVersionId (id job’а вернуть в ответ)
	•	Анализ сохраняй строго под versionId=newVersionId.

C. Гарантируй атомарность применения рекомендаций
	•	Эндпоинт «apply all» должен завершить транзакцию по сценам до создания версии.
	•	Возвращай updatedSceneCount и финальный снапшот сцен, который реально пойдёт в версию.

Фронтенд

D. Делай «Сохранить новую версию» после применения
	•	После одиночной/массовой «Применить» жди завершения мутации и refetch’а scenes.
	•	Активируй «Сохранить новую версию» только когда есть несохранённые изменения.

E. После сохранения версии — автозапуск анализа + контролируемый поллинг
	•	Сразу после saveVersion():
	•	сохрани baseVersionId (текущая) и targetVersionId (новая),
	•	запусти анализ для targetVersionId,
	•	покажи информер «Считаем новую версию…».
	•	Поллинг /analysis/status?versionId=targetVersionId до done|error.

F. Модалка сравнения работает только с явными versionId
	•	Открывая модалку, зови GET /compare?baseVersionId=...&targetVersionId=....
	•	Состояния:
	•	если статус queued|running → скелетон/индикатор + кнопку «Принять новую версию» скрыть,
	•	если done → показать метрики, дельты и рецензию,
	•	если error → показать «Пересчитать» (повторный запуск анализа именно для targetVersionId).

G. Не показывай «0/0/0» как реальные цифры
	•	Пока нет данных — показывай placeholder «Идёт анализ…».
	•	Нули показывай только если analysis реально вернулся и это нули (редкий случай).

H. Кнопки в модалке
	•	«Принять новую версию» — активна только при статусе done.
	•	«Вернуться к редактированию» — всегда.
	•	«Перейти к озвучке» — активна только после принятия (или если пользователь явно выбрал новую версию).

Проверка (DoD)
	1.	Применяешь рекомендации → кнопка «Сохранить новую версию» активна.
	2.	Жмёшь сохранить → тост «версия vN+1 создана, идёт анализ», появляется кнопка «Сравнить…».
	3.	Открываешь сравнение сразу — вкладка «Метрики» показывает скелетон; вкладка «Сцены» уже показывает разные тексты.
	4.	Через ~10–30 сек: появляются не нулевые баллы «ПОСЛЕ», дельты и рецензия.
	5.	«Принять новую версию» становится активной; по нажатию — baseVersionId обновляется на новую, модалка закрывается, на карточке анализа справа показывается свежий общий балл.

Почему балл «ПОСЛЕ» мог быть ниже
	•	Ты нажал «Сравнение» до окончания анализа — UI показал 0, как будто хуже. После фикса это будет скелетон.
	•	Применились рекомендации «high/medium», но текст версии сохранился до того, как мутация реально дописала сцены — новая версия оказалась с частично старым текстом. Мы закрываем это транзакцией и ожиданием refetch перед сохранением.
	•	Модель могла реально дать вариант хуже (редко, но бывает). Тогда в «Метриках» будут честные −Δ, и ты просто оставишь текущую версию. Это ок.

Что ты увидишь после фикса
	•	В «Сцены» — разные тексты без артефактов.
	•	В «Метрики» — корректные числа и рецензия с обеих сторон.
	•	Никаких нулей/«Недоступно» при готовом анализе.
	•	Кнопка «Принять новую версию» — только когда всё посчитано.

если хочешь, я набросаю конкретные сигнатуры эндпоинтов и имена полей под твой текущий код, чтобы просто вставить и не думать о нейминге.