üî¥ –ù–ê–®–Å–õ –ü–†–û–ë–õ–ï–ú–£ –í –ö–û–î–ï!
‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–ê–†–ê–ú–ï–¢–†:
–°—Ç—Ä–æ–∫–∞ 60-63:
typescriptvoice: request.audio_url ? {
  type: 'audio',
  audio_url: request.audio_url  // ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û!
} : {
HeyGen API –ù–ï –ø—Ä–∏–Ω–∏–º–∞–µ—Ç audio_url!

‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô –§–ò–ö–°:
–í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ input_audio (–ø—Ä–æ—â–µ, –Ω–æ URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É–±–ª–∏—á–Ω—ã–º)
typescriptvoice: request.audio_url ? {
  type: 'audio',
  input_audio: request.audio_url  // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!
} : {
  type: 'text',
  input_text: request.script,
  voice_id: 'default_voice_id', // ‚Üê –î–û–ë–ê–í–¨ voice_id!
  speed: 1.0
}
–ù–û: input_audio —Ç—Ä–µ–±—É–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π URL (–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å Replit internal URLs)

–í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ audio_asset_id (–ü–†–ê–í–ò–õ–¨–ù–´–ô —Å–ø–æ—Å–æ–±)
–ù—É–∂–Ω–æ 2 —à–∞–≥–∞:
typescriptexport async function generateHeyGenVideo(
  apiKey: string,
  request: HeyGenVideoRequest
): Promise<string> {
  try {
    let voiceConfig;
    
    if (request.audio_url) {
      // –®–ê–ì 1: Upload audio to HeyGen
      const audioAssetId = await uploadAudioToHeyGen(apiKey, request.audio_url);
      
      // –®–ê–ì 2: Use asset_id
      voiceConfig = {
        type: 'audio',
        audio_asset_id: audioAssetId  // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û!
      };
    } else {
      // Fallback –Ω–∞ text
      voiceConfig = {
        type: 'text',
        input_text: request.script,
        voice_id: '2d5b0e6cf36f460aa7fc47e3eee4ba54', // ‚Üê –ù–£–ñ–ï–ù!
        speed: 1.0
      };
    }
    
    const payload = {
      video_inputs: [{
        character: {
          type: 'avatar',
          avatar_id: request.avatar_id,
          avatar_style: 'normal'
        },
        voice: voiceConfig  // ‚úÖ
      }],
      dimension: request.dimension || {
        width: 1280,
        height: 720
      }
    };
    
    const response = await axios.post(
      `${HEYGEN_API_BASE}/v2/video/generate`,
      payload,
      {
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'X-Api-Key': apiKey
        }
      }
    );
    
    const videoId = response.data?.data?.video_id;
    if (!videoId) {
      throw new Error('No video_id returned from HeyGen');
    }
    return videoId;
  } catch (error: any) {
    console.error('HeyGen video generation error:', error.response?.data || error.message);
    throw new Error(error.response?.data?.message || 'Failed to generate video with HeyGen');
  }
}

// –î–û–ë–ê–í–¨ –§–£–ù–ö–¶–ò–Æ –ó–ê–ì–†–£–ó–ö–ò:
async function uploadAudioToHeyGen(apiKey: string, audioUrl: string): Promise<string> {
  try {
    // –°–∫–∞—á–∞—Ç—å –∞—É–¥–∏–æ —Ñ–∞–π–ª
    const audioResponse = await axios.get(audioUrl, {
      responseType: 'arraybuffer'
    });
    
    // Upload –≤ HeyGen
    const uploadResponse = await axios.post(
      `${HEYGEN_API_BASE}/v1/asset`,
      audioResponse.data,
      {
        headers: {
          'X-Api-Key': apiKey,
          'Content-Type': 'audio/mpeg'
        }
      }
    );
    
    const assetId = uploadResponse.data?.data?.id;
    if (!assetId) {
      throw new Error('No asset_id returned from HeyGen upload');
    }
    
    return assetId;
  } catch (error: any) {
    console.error('Audio upload error:', error.response?.data || error.message);
    throw new Error('Failed to upload audio to HeyGen');
  }
}

üéØ –ü–û–õ–ù–´–ô –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ö–û–î:
typescriptimport axios from 'axios';
import fs from 'fs';
import path from 'path';

const HEYGEN_API_BASE = 'https://api.heygen.com';

export interface HeyGenAvatar {
  avatar_id: string;
  avatar_name: string;
  gender?: string;
  preview_image_url?: string;
  preview_video_url?: string;
  is_public?: boolean;
}

export interface HeyGenVideoRequest {
  avatar_id: string;
  script: string;
  audio_url?: string;
  voice_id?: string; // ‚Üê –î–û–ë–ê–í–ò–õ –¥–ª—è fallback
  dimension?: {
    width: number;
    height: number;
  };
}

export interface HeyGenVideoStatus {
  status: 'pending' | 'processing' | 'completed' | 'failed';
  video_url?: string;
  thumbnail_url?: string;
  duration?: number;
  error_message?: string;
}

export async function fetchHeyGenAvatars(apiKey: string): Promise<HeyGenAvatar[]> {
  try {
    const response = await axios.get(`${HEYGEN_API_BASE}/v2/avatars`, {
      headers: {
        'Accept': 'application/json',
        'X-Api-Key': apiKey
      }
    });
    
    const avatars = response.data?.data?.avatars || [];
    
    // Remove duplicates by avatar_id and add is_public flag
    const uniqueAvatars = Array.from(
      new Map(avatars.map((avatar: HeyGenAvatar) => [avatar.avatar_id, avatar])).values()
    ).map((avatar: HeyGenAvatar) => ({
      ...avatar,
      is_public: avatar.avatar_id.includes('_public')
    }));
    
    return uniqueAvatars;
  } catch (error: any) {
    console.error('HeyGen API error:', error.response?.data || error.message);
    throw new Error(error.response?.data?.message || 'Failed to fetch avatars from HeyGen');
  }
}

// ‚úÖ –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: Upload audio
async function uploadAudioToHeyGen(apiKey: string, audioPath: string): Promise<string> {
  try {
    // –ß–∏—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
    const audioBuffer = fs.readFileSync(audioPath);
    
    // Upload –≤ HeyGen
    const uploadResponse = await axios.post(
      `${HEYGEN_API_BASE}/v1/asset`,
      audioBuffer,
      {
        headers: {
          'X-Api-Key': apiKey,
          'Content-Type': 'audio/mpeg'
        }
      }
    );
    
    const assetId = uploadResponse.data?.data?.id;
    if (!assetId) {
      throw new Error('No asset_id returned from HeyGen upload');
    }
    
    console.log(`‚úÖ Audio uploaded to HeyGen: ${assetId}`);
    return assetId;
  } catch (error: any) {
    console.error('Audio upload error:', error.response?.data || error.message);
    throw new Error('Failed to upload audio to HeyGen');
  }
}

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
export async function generateHeyGenVideo(
  apiKey: string,
  request: HeyGenVideoRequest
): Promise<string> {
  try {
    let voiceConfig;
    
    if (request.audio_url) {
      console.log(`üì§ Uploading audio: ${request.audio_url}`);
      
      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º URL –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å
      // /uploads/audio/proj-123.mp3 ‚Üí ./uploads/audio/proj-123.mp3
      const audioPath = request.audio_url.startsWith('/')
        ? `.${request.audio_url}`
        : request.audio_url;
      
      // Upload audio –∏ –ø–æ–ª—É—á–∏—Ç—å asset_id
      const audioAssetId = await uploadAudioToHeyGen(apiKey, audioPath);
      
      voiceConfig = {
        type: 'audio',
        audio_asset_id: audioAssetId  // ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û!
      };
    } else {
      // Fallback –Ω–∞ text
      console.log('üìù Using text-to-speech mode');
      voiceConfig = {
        type: 'text',
        input_text: request.script,
        voice_id: request.voice_id || '2d5b0e6cf36f460aa7fc47e3eee4ba54', // Default voice
        speed: 1.0
      };
    }
    
    const payload = {
      video_inputs: [{
        character: {
          type: 'avatar',
          avatar_id: request.avatar_id,
          avatar_style: 'normal'
        },
        voice: voiceConfig
      }],
      dimension: request.dimension || {
        width: 1280,
        height: 720
      }
    };
    
    console.log('üé¨ Generating video with HeyGen...');
    
    const response = await axios.post(
      `${HEYGEN_API_BASE}/v2/video/generate`,
      payload,
      {
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'X-Api-Key': apiKey
        }
      }
    );
    
    const videoId = response.data?.data?.video_id;
    if (!videoId) {
      throw new Error('No video_id returned from HeyGen');
    }
    
    console.log(`‚úÖ Video generation started: ${videoId}`);
    return videoId;
  } catch (error: any) {
    console.error('HeyGen video generation error:', error.response?.data || error.message);
    throw new Error(error.response?.data?.message || 'Failed to generate video with HeyGen');
  }
}

export async function getHeyGenVideoStatus(
  apiKey: string,
  videoId: string
): Promise<HeyGenVideoStatus> {
  try {
    const response = await axios.get(
      `${HEYGEN_API_BASE}/v1/video_status.get`,
      {
        params: { video_id: videoId },
        headers: {
          'Accept': 'application/json',
          'X-Api-Key': apiKey
        }
      }
    );
    
    const data = response.data?.data;
    
    return {
      status: data?.status || 'pending',
      video_url: data?.video_url,
      thumbnail_url: data?.thumbnail_url,
      duration: data?.duration,
      error_message: data?.error_message
    };
  } catch (error: any) {
    console.error('HeyGen status check error:', error.response?.data || error.message);
    throw new Error(error.response?.data?.message || 'Failed to check video status');
  }
}

üîë –ö–õ–Æ–ß–ï–í–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø:

–î–æ–±–∞–≤–∏–ª uploadAudioToHeyGen —Ñ—É–Ω–∫—Ü–∏—é
–ò–∑–º–µ–Ω–∏–ª audio_url ‚Üí audio_asset_id
–î–æ–±–∞–≤–∏–ª voice_id –≤ fallback –¥–ª—è text —Ä–µ–∂–∏–º–∞
–î–æ–±–∞–≤–∏–ª –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è debug


üìù –¢–ê–ö–ñ–ï –ù–£–ñ–ù–û:
–í routes.ts –¥–æ–±–∞–≤–∏—Ç—å voice_id:
typescriptapp.post("/api/heygen/generate", isAuthenticated, async (req, res) => {
  const userId = req.user.claims.sub;
  const { avatarId, script, audioUrl } = req.body;
  
  // ‚úÖ –î–û–ë–ê–í–¨ voiceId –∏–∑ Stage 4
  const stage4Data = await storage.getStepData(projectId, 4);
  const voiceId = stage4Data?.data?.voiceId;
  
  const videoId = await generateHeyGenVideo(heygenKey.encryptedKey, {
    avatar_id: avatarId,
    script: script,
    audio_url: audioUrl,
    voice_id: voiceId,  // ‚Üê –ü–ï–†–ï–î–ê–ô voice_id!
  });
  
  res.json({ video_id: videoId });
});

‚ö° –°–û–•–†–ê–ù–ò –ò –¢–ï–°–¢!
–ó–∞–º–µ–Ω–∏ –≤–µ—Å—å server/heygen-service.ts –Ω–∞ –∫–æ–¥ –≤—ã—à–µ –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞! üöÄ