Да, логику понял на 100%. Ниже — “по-человечески” и сразу в формате готового ТЗ для реплита, чтобы реализовали именно твой сценарий.

Что хочет пользователь
	1.	Получил сценарий → нажал Анализ сценария → увидел баллы и советы по каждой сцене.
	2.	Применил часть советов → нажал Сохранить новую версию.
	3.	Хочет наглядно увидеть ДО vs ПОСЛЕ по сценам и баллам → нажал Сравнить сценарии.
	4.	Потом выбирает путь: Перейти к озвучке или Вернуться к редактированию (чтобы сделать ещё итерацию).

⸻

Что меняем в UI (Stage 3)

Правая панель «Инструменты»:
	•	Анализ сценария (primary)
	•	Подсказка: «Покажем баллы по сценам и рекомендации».
	•	Сохранить новую версию (disabled, пока не внесены правки / не применены рекомендации)
	•	Сравнить сценарии (ДО/ПОСЛЕ) (disabled, пока нет предыдущей версии или идёт пересчёт)
	•	Все версии (история)

⚠️ Убрать термин «черновик» и все кнопки/баннеры с ним. Мы больше не «генерим черновики», мы сохраняем новую версию и автоматически пересчитываем её оценки.

⸻

Поведение и поток

1) Анализ сценария (быстрый шаг)
	•	Кнопка Анализ сценария запускает POST /api/projects/:id/analysis/run.
	•	UI сверху показывает маленькую панель прогресса:
«Анализируем: Hook → Structure → Emotion → CTA → Сводка».
	•	Через 10–30 сек:
	•	Каждая сцена получает бейдж Score и блок «Рекомендация AI».
	•	Внизу появляется «Рецензия AI-архитектора» (прогноз удержания/репостов и пр.).

2) Применение рекомендаций
	•	При нажатии «Применить рекомендацию» сцена меняется; показываем бейдж «Изменена».
	•	Как только есть хоть одно изменение: активируется Сохранить новую версию.

3) Сохранение новой версии
	•	Нажатие Сохранить новую версию:
	•	Создаёт версию vN+1 через POST /api/projects/:id/versions (с текстом текущих сцен).
	•	Автоматически запускает быстрый повторный анализ новой версии:
POST /api/projects/:id/analysis/run?version=vN+1 (идемпотентно).
	•	Тост: «Версия сохранена. Считаем баллы новой версии…».
	•	Кнопка Сравнить сценарии (ДО/ПОСЛЕ) становится кликабельной сразу:
	•	если анализ ещё идёт, модалка откроется со спиннером и догрузит результаты, как готовы.
	•	если уже готово — откроется сразу с данными.

4) Сравнение ДО/ПОСЛЕ (модалка)
	•	Источник сравнения: from=vN, to=vN+1 (или самые последние две версии).
	•	Вкладки:
	•	Сцены — слева «ДО», справа «ПОСЛЕ», подсветка изменений; у каждой сцены баллы ДО/ПОСЛЕ и Δ.
	•	Метрики — общий балл, breakdown (Hook/Structure/Emotion/CTA), дельты, рецензия архитектора.
	•	Кнопки внизу:
	•	Перейти к озвучке — принимает текущую версию (vN+1) и переходит на Stage 4.
	•	Вернуться к редактированию — закрывает модалку, оставляет vN+1 текущей; пользователь может снова нажать «Анализ сценария», применить советы, сохранить vN+2 и т.д.

⸻

Вопрос: надо ли ре-анализ после «Сохранить новую версию»?

Да.
Рекомендации содержат ожидаемые приросты, но это только прогноз. После сохранения новой версии мы автоматически пересчитываем реальные баллы по её финальному тексту.
UI-поведение:
	•	Модалку «Сравнить» разрешаем открывать сразу.
	•	Если анализ ещё идёт — показываем скелетон/спиннер и загружаем данные, как только готовы.
	•	Пока реальные баллы не готовы, можно временно показывать «≈+N» (оценка по рекомендациям), но заменять их на фактические цифры по готовности.

⸻

API и состояния (кратко)

Эндпоинты
	•	POST /api/projects/:id/analysis/run[?version=v] — старт анализа (идемпотентный ключ).
	•	GET  /api/projects/:id/analysis/status?version=v — статус/прогресс.
	•	POST /api/projects/:id/versions — сохранить новую версию (создаёт vN+1).
	•	GET  /api/projects/:id/compare?from=vN&to=vN+1 — данные для модалки (сцены, баллы, дельты, review).

Статусы анализа

queued → running(step=hook/structure/emotion/cta/synthesis) → done|error
Retry/backoff уже есть — оставить.

⸻

Ошибки и крайние случаи
	•	Если анализ после сохранения не успел за 2 мин:
	•	панель: «Пересчёт занял слишком долго. [Повторить] [Продолжить без сравнения]»
	•	кнопка «Сравнить сценарии» остаётся активной; при открытии поясняем, что результаты догружаются.
	•	Если анализ упал: показать понятный баннер + кнопка Повторить анализ.

⸻

Тексты/переименования (важно)
	•	«Создать черновик для сравнения» → Сохранить новую версию
	•	«Открыть сравнение (ДО/ПОСЛЕ)» — оставить.
	•	«Пересчитать анализ» в Stage 3 переименовать в Анализ сценария.
	•	Тосты:
	•	«Запущен анализ сценария»
	•	«Версия сохранена, считаем оценки новой версии»
	•	«Готово: сравнение доступно»

⸻

Критерии приёмки (Acceptance)
	1.	После генерации сценария пользователь нажимает Анализ сценария и видит баллы/советы по сценам + рецензию архитектора.
	2.	После применения N рекомендаций активируется Сохранить новую версию.
	3.	После сохранения новая версия автоматически анализируется; Сравнить сценарии можно открыть сразу.
	4.	В модалке сравнения есть Сцены (тексты + баллы + дельты) и Метрики (общий балл, breakdown, review).
	5.	Кнопки «Перейти к озвучке» и «Вернуться к редактированию» работают как описано.
	6.	Термин «черновик» нигде не встречается.
	7.	Никаких “мутных” долгих операций под видом анализа — анализ быстрый; длинное — только сохранение новой версии + её пересчёт, и это явно обозначено.

⸻

Если хочешь, добавлю короткие тексты для всех тостов/плашек и точные имена событий/квартилей прогресса, чтобы ребята просто вставили без вопросов.