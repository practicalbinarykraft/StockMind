поймал твою боль. Коротко: «магия» с точечными правками по каждой сцене никуда не должна была исчезать — сейчас она просто не вызывается/не мапится в UI после рефакторинга «черновиков». Давай вернём как было и зафиксируем это жёстко в ТЗ.

Что именно сломано
	1.	Анализ сцены↔рекомендации разорваны: архитектор выдаёт общий обзор, а генератор «scene-level suggestions» не вызывается (или его ответ не кладётся в storage и не подтягивается в UI).
	2.	В SceneCard показывается только текст сцены и общая оценка, но не подхватывается блок recommendations[] для данной сцены.
	3.	После «Анализ сценария» бек возвращает analysisResult/architectReview, но нет массива sceneRecommendations (или он пуст/не мапится).

Быстрый план восстановления (без модалки, только хороший анализ)

0) Названия и где правим
	•	Backend: server/routes.ts, server/ai-service.ts (или твой слой провайдера LLM), server/storage.ts
	•	Общие типы: shared/schema.ts
	•	Frontend: client/src/components/project/scene-editor.tsx, client/src/components/project/scene-card.tsx

⸻

1) API: вернуть «рекомендации для каждой сцены»

1.1. Endpoint запуска анализа

Оставляем одну кнопку «Анализ сценария» → дергаем:

POST /api/projects/:projectId/analysis/run

Ответ (минимум):

{
  "success": true,
  "data": {
    "versionId": "vN",
    "overallScore": 66,
    "breakdown": { "hook": 82, "structure": 58, "emotional": 0, "cta": 0 },
    "architectReview": { "summary": "...", "pros": [...], "cons": [...], "forecast": {...} },
    "sceneRecommendations": [
      {
        "sceneNumber": 1,
        "currentText": "…",
        "scoreBefore": 45,
        "area": "hook|structure|emotion|cta|pacing|clarity",
        "priority": "high|medium|low",
        "suggestedText": "…",              // готовая замена
        "delta": +14,                        // ожидаемый прирост
        "rationale": "почему это лучше"
      },
      ...
    ]
  }
}

1.2. Как получаем рекомендации на бэке
	•	В ai-service.ts добавить функцию типа generateSceneRecommendations(scenes, context).
	•	Она вызывает LLM по каждой сцене (или батчом), просит:
	•	краткий скоринг текущей сцены,
	•	1–2 конкретных варианта улучшенного текста,
	•	область улучшения (hook/structure/emotion/cta/…),
	•	ожидаемый прирост (эвристика нормируется к 0..+20).
	•	Параллель: ограничить по 2–3 одновременно (rate limit).
	•	Результат сложить в sceneRecommendations[] и вернуть в analysis/run.

Важно: не смешиваем с «черновиком/сравнением». Это отдельный быстрый анализ текущей версии.

1.3. Storage (если нужно сохранять)
	•	В storage.ts добавить saveSceneRecommendations(projectId, versionId, recs) и getSceneRecommendations(projectId, versionId).
	•	Типы в shared/schema.ts для SceneRecommendation.

⸻

2) UI: показать «магические» правки прямо в редакторе

2.1. Панель анализа (правая колонка)
	•	Уже есть «Результаты анализа» и «Рецензия AI архитектора» — оставляем.
	•	Ниже добавить блок «Рекомендации по сценам (N)».

2.2. В SceneCard

Для каждой сцены показываем, если есть рекомендации для её sceneNumber:
	•	бейдж «+14 баллов • CTA» (пример),
	•	suggestedText в зелёном блоке «Предложение»,
	•	rationale мелким серым,
	•	кнопки:
	•	[Применить рекомендацию] — заменяет текст сцены на suggestedText, ставит метку «изменено».
	•	[Отклонить] — скрывает рекомендацию для этой сцены.
	•	Доп. опция над списком сцен: [Применить всё (выгодные)] — применяет только high/medium c delta >= X (например, ≥6).

2.3. Поведение кнопок
	•	«Анализ сценария»: крутит прогресс «Hook → Structure → Emotion → CTA → Сводка», по завершении наполняет sceneRecommendations в стейте.
	•	«Сохранить новую версию»:
	•	пишет vN+1 в историю,
	•	(опционально) сразу запускает быстрый auto-реанализ, чтобы обновить общий балл и дельты (но сравнение — это уже отдельный следующий шаг, без модалки).
	•	«Перейти к озвучке»: оставляем как есть.

⸻

3) Мини-чек-лист для реплита (делай по пунктам)
	1.	Backend
	•	В ai-service.ts добавить generateSceneRecommendations(scenes, context) (per-scene).
	•	В routes.ts в POST /analysis/run дополнить возврат sceneRecommendations (см. JSON выше).
	•	(Опц.) В storage.ts сохранить/читать рекомендации для versionId.
	2.	Types
	•	В shared/schema.ts добавить SceneRecommendation (sceneNumber, suggestedText, delta, area, priority, rationale).
	3.	Frontend
	•	В scene-editor.tsx после анализа класть sceneRecommendations в стейт рядом со сценами.
	•	В scene-card.tsx показать блок рекомендаций и кнопки «Применить/Отклонить».
	•	Реализовать «Применить всё (выгодные)» + рефетч сцен.
	•	Не трогаем модалку сравнения. Кнопка сравнения остаётся отдельным шагом.
	4.	UX детали
	•	Прогресс-анимация шагов анализа (есть — оставить).
	•	Тосты: «Анализ готов» → «Рекомендации загружены: N сцен».
	•	После «Сохранить новую версию» — тост и авто-реанализ (без модалки).
	5.	QA
	•	На скрипте из 4–6 сцен видим по каждой сцене карточку с предложением и «+delta».
	•	«Применить» меняет текст сцены мгновенно; «Применить всё» применяет только выгодные.
	•	«Сохранить новую версию» создаёт vN+1; общий балл обновляется.

⸻

Почему оно могло «пропасть»

Типичные причины регресса, которые я вижу по симптомам:
	•	После рефакторинга «черновика/сравнения» endpoint анализа стал возвращать только overallScore/breakdown/review, а генерацию sceneRecommendations случайно выпилили/не зовут.
	•	На фронте SceneCard теперь не получает/не мапит recommendations (пропсы/состояние сменили имена).
	•	Смена логики sceneId/index → sceneNumber могла «развязать» рекомендации от нужных сцен.

⸻

Что тебе писать в чат реплиту (готовая формулировка)

Верните «магические» рекомендации по сценам прямо в редактор:
	1.	POST /api/projects/:id/analysis/run должен возвращать sceneRecommendations[] (см. JSON-схему выше) — для каждой сцены конкретный suggestedText, delta, area, priority, rationale.
	2.	На фронте в SceneCard под текущим текстом добавить блок «Предложение» с кнопками «Применить»/«Отклонить»; сверху — «Применить всё (выгодные)».
	3.	Не трогаем модалку сравнения — это отдельный шаг позже. Здесь нужен хороший анализ с точечными заменами.
	4.	Использовать sceneNumber для маппинга рекомендаций к сценам. После «Сохранить новую версию» запустить быстрый авто-реанализ (без модалки) и обновить общий балл.
	5.	Добавить тосты: «Рекомендации загружены: N сцен», «Применено X рекомендаций».

Если хочешь — могу ещё ужать это до чек-листа с галочками для вставки в replit.md.